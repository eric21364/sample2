function Option(t,e){this.flags=t,this.required=~t.indexOf("<"),this.optional=~t.indexOf("["),this.bool=!~t.indexOf("-no-"),t=t.split(/[ ,|]+/),t.length>1&&!/^[[<]/.test(t[1])&&(this["short"]=t.shift()),this["long"]=t.shift(),this.description=e||""}function Command(t){this.commands=[],this.options=[],this._execs=[],this._allowUnknownOption=!1,this._args=[],this._name=t}function camelcase(t){return t.split("-").reduce(function(t,e){return t+e[0].toUpperCase()+e.slice(1)})}function pad(t,e){var n=Math.max(0,e-t.length);return t+Array(n+1).join(" ")}function outputHelpIfNecessary(t,e){e=e||[];for(var n=0;n<e.length;n++)("--help"==e[n]||"-h"==e[n])&&(t.outputHelp(),process.exit(0))}function humanReadableArgName(t){var e=t.name+(t.variadic===!0?"...":"");return t.required?"<"+e+">":"["+e+"]"}var EventEmitter=require("events").EventEmitter,spawn=require("child_process").spawn,path=require("path"),dirname=path.dirname,basename=path.basename;exports=module.exports=new Command,exports.Command=Command,exports.Option=Option,Option.prototype.name=function(){return this["long"].replace("--","").replace("no-","")},Option.prototype.is=function(t){return t==this["short"]||t==this["long"]},Command.prototype.__proto__=EventEmitter.prototype,Command.prototype.command=function(t,e){var n=t.split(/ +/),i=new Command(n.shift());return e&&(i.description(e),this.executables=!0,this._execs[i._name]=!0),this.commands.push(i),i.parseExpectedArgs(n),i.parent=this,e?this:i},Command.prototype.addImplicitHelpCommand=function(){this.command("help [cmd]","display help for [cmd]")},Command.prototype.parseExpectedArgs=function(t){if(t.length){var e=this;return t.forEach(function(t){var n={required:!1,name:"",variadic:!1};switch(t[0]){case"<":n.required=!0,n.name=t.slice(1,-1);break;case"[":n.name=t.slice(1,-1)}n.name.length>3&&"..."===n.name.slice(-3)&&(n.variadic=!0,n.name=n.name.slice(0,-3)),n.name&&e._args.push(n)}),this}},Command.prototype.action=function(t){var e=this,n=function(n,i){n=n||[],i=i||[];var r=e.parseOptions(i);outputHelpIfNecessary(e,r.unknown),r.unknown.length>0&&e.unknownOption(r.unknown[0]),r.args.length&&(n=r.args.concat(n)),e._args.forEach(function(t,i){t.required&&null==n[i]?e.missingArgument(t.name):t.variadic&&(i!==e._args.length-1&&e.variadicArgNotLast(t.name),n[i]=n.splice(i))}),e._args.length?n[e._args.length]=e:n.push(e),t.apply(e,n)};return this.parent.on(this._name,n),this._alias&&this.parent.on(this._alias,n),this},Command.prototype.option=function(t,e,n,i){var r=this,a=new Option(t,e),o=a.name(),s=camelcase(o);return"function"!=typeof n&&(i=n,n=null),(0==a.bool||a.optional||a.required)&&(0==a.bool&&(i=!0),void 0!==i&&(r[s]=i)),this.options.push(a),this.on(o,function(t){null!==t&&n&&(t=n(t,void 0===r[s]?i:r[s])),"boolean"==typeof r[s]||"undefined"==typeof r[s]?null==t?r[s]=a.bool?i||!0:!1:r[s]=t:null!==t&&(r[s]=t)}),this},Command.prototype.allowUnknownOption=function(t){return this._allowUnknownOption=0===arguments.length||t,this},Command.prototype.parse=function(t){this.executables&&this.addImplicitHelpCommand(),this.rawArgs=t,this._name=this._name||basename(t[1],".js");var e=this.parseOptions(this.normalize(t.slice(2))),n=this.args=e.args,i=this.parseArgs(this.args,e.unknown),r=i.args[0];return this._execs[r]&&"function"!=typeof this._execs[r]?this.executeSubCommand(t,n,e.unknown):i},Command.prototype.executeSubCommand=function(t,e,n){e=e.concat(n),e.length||this.help(),"help"==e[0]&&1==e.length&&this.help(),"help"==e[0]&&(e[0]=e[1],e[1]="--help");var i=dirname(t[1]),r=basename(t[1],".js")+"-"+e[0],a=path.join(i,r);e=e.slice(1),e.unshift(a);var o=spawn("node",e,{stdio:"inherit",customFds:[0,1,2]});o.on("error",function(t){"ENOENT"==t.code?console.error("\n  %s(1) does not exist, try --help\n",r):"EACCES"==t.code&&console.error("\n  %s(1) not executable. try chmod or run with root\n",r)}),this.runningCommand=o},Command.prototype.normalize=function(t){for(var n,i,r,e=[],a=0,o=t.length;o>a;++a){if(n=t[a],a>0&&(i=this.optionFor(t[a-1])),"--"===n){e=e.concat(t.slice(a));break}i&&i.required?e.push(n):n.length>1&&"-"==n[0]&&"-"!=n[1]?n.slice(1).split("").forEach(function(t){e.push("-"+t)}):/^--/.test(n)&&~(r=n.indexOf("="))?e.push(n.slice(0,r),n.slice(r+1)):e.push(n)}return e},Command.prototype.parseArgs=function(t,e){var n;return t.length?(n=t[0],this.listeners(n).length?this.emit(t.shift(),t,e):this.emit("*",t)):(outputHelpIfNecessary(this,e),e.length>0&&this.unknownOption(e[0])),this},Command.prototype.optionFor=function(t){for(var e=0,n=this.options.length;n>e;++e)if(this.options[e].is(t))return this.options[e]},Command.prototype.parseOptions=function(t){for(var i,r,a,e=[],n=t.length,o=[],s=0;n>s;++s)if(a=t[s],"--"!=a)if(i)e.push(a);else if(r=this.optionFor(a))if(r.required){if(a=t[++s],null==a)return this.optionMissingArgument(r);this.emit(r.name(),a)}else r.optional?(a=t[s+1],null==a||"-"==a[0]&&"-"!=a?a=null:++s,this.emit(r.name(),a)):this.emit(r.name());else a.length>1&&"-"==a[0]?(o.push(a),t[s+1]&&"-"!=t[s+1][0]&&o.push(t[++s])):e.push(a);else i=!0;return{args:e,unknown:o}},Command.prototype.opts=function(){for(var t={},e=this.options.length,n=0;e>n;n++){var i=this.options[n].name();t[i]="version"===i?this._version:this[i]}return t},Command.prototype.missingArgument=function(t){console.error(),console.error("  error: missing required argument `%s'",t),console.error(),process.exit(1)},Command.prototype.optionMissingArgument=function(t,e){console.error(),e?console.error("  error: option `%s' argument missing, got `%s'",t.flags,e):console.error("  error: option `%s' argument missing",t.flags),console.error(),process.exit(1)},Command.prototype.unknownOption=function(t){this._allowUnknownOption||(console.error(),console.error("  error: unknown option `%s'",t),console.error(),process.exit(1))},Command.prototype.variadicArgNotLast=function(t){console.error(),console.error("  error: variadic arguments must be last `%s'",t),console.error(),process.exit(1)},Command.prototype.version=function(t,e){return 0==arguments.length?this._version:(this._version=t,e=e||"-V, --version",this.option(e,"output the version number"),this.on("version",function(){process.stdout.write(t+"\n"),process.exit(0)}),this)},Command.prototype.description=function(t){return 0==arguments.length?this._description:(this._description=t,this)},Command.prototype.alias=function(t){return 0==arguments.length?this._alias:(this._alias=t,this)},Command.prototype.usage=function(t){var e=this._args.map(function(t){return humanReadableArgName(t)}),n="[options]"+(this.commands.length?" [command]":"")+(this._args.length?" "+e.join(" "):"");return 0==arguments.length?this._usage||n:(this._usage=t,this)},Command.prototype.name=function(t){return this._name},Command.prototype.largestOptionLength=function(){return this.options.reduce(function(t,e){return Math.max(t,e.flags.length)},0)},Command.prototype.optionHelp=function(){var t=this.largestOptionLength();return[pad("-h, --help",t)+"  output usage information"].concat(this.options.map(function(e){return pad(e.flags,t)+"  "+e.description})).join("\n")},Command.prototype.commandHelp=function(){if(!this.commands.length)return"";var t=this.commands.map(function(t){var e=t._args.map(function(t){return humanReadableArgName(t)}).join(" ");return[t._name+(t._alias?"|"+t._alias:"")+(t.options.length?" [options]":"")+" "+e,t.description()]}),e=t.reduce(function(t,e){return Math.max(t,e[0].length)},0);return["","  Commands:","",t.map(function(t){return pad(t[0],e)+"  "+t[1]}).join("\n").replace(/^/gm,"    "),""].join("\n")},Command.prototype.helpInformation=function(){var t=[];this._description&&(t=["  "+this._description,""]);var e=this._name;this._alias&&(e=e+"|"+this._alias);var n=["","  Usage: "+e+" "+this.usage(),""],i=[],r=this.commandHelp();r&&(i=[r]);var a=["  Options:","",""+this.optionHelp().replace(/^/gm,"    "),"",""];return n.concat(i).concat(t).concat(a).join("\n")},Command.prototype.outputHelp=function(){process.stdout.write(this.helpInformation()),this.emit("--help")},Command.prototype.help=function(){this.outputHelp(),process.exit()};