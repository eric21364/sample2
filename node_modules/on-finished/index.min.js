"use strict";function onFinished(t,e){return isFinished(t)!==!1?(defer(e,null,t),t):(attachListener(t,e),t)}function isFinished(t){var e=t.socket;return"boolean"==typeof t.finished?Boolean(t.finished||e&&!e.writable):"boolean"==typeof t.complete?Boolean(t.upgrade||!e||!e.readable||t.complete&&!t.readable):void 0}function attachFinishedListener(t,e){function a(t){n.cancel(),r.cancel(),i=!0,e(t)}function s(e){t.removeListener("socket",s),i||n===r&&(r=first([[e,"error","close"]],a))}var n,r,i=!1;return n=r=first([[t,"end","finish"]],a),t.socket?void s(t.socket):(t.on("socket",s),void(void 0===t.socket&&patchAssignSocket(t,s)))}function attachListener(t,e){var n=t.__onFinished;n&&n.queue||(n=t.__onFinished=createListener(t),attachFinishedListener(t,n)),n.queue.push(e)}function createListener(t){function e(n){if(t.__onFinished===e&&(t.__onFinished=null),e.queue){var r=e.queue;e.queue=null;for(var i=0;i<r.length;i++)r[i](n,t)}}return e.queue=[],e}function patchAssignSocket(t,e){var n=t.assignSocket;"function"==typeof n&&(t.assignSocket=function(t){n.call(this,t),e(t)})}module.exports=onFinished,module.exports.isFinished=isFinished;var first=require("ee-first"),defer="function"==typeof setImmediate?setImmediate:function(t){process.nextTick(t.bind.apply(t,arguments))};