"use strict";function getDecoder(t){if(!t)return null;try{return iconv.getDecoder(t)}catch(e){if(!iconvEncodingMessageRegExp.test(e.message))throw e;throw createError(415,"specified encoding unsupported","encoding.unsupported",{encoding:t})}}function getRawBody(t,e,r){var n=r,i=e||{};if((e===!0||"string"==typeof e)&&(i={encoding:e}),"function"==typeof e&&(n=e,i={}),void 0!==n&&"function"!=typeof n)throw new TypeError("argument callback must be a function");if(!n&&!global.Promise)throw new TypeError("argument callback is required");var a=i.encoding!==!0?i.encoding:"utf-8",s=bytes.parse(i.limit),o=null==i.length||isNaN(i.length)?null:parseInt(i.length,10);return n?readStream(t,a,o,s,n):new Promise(function(e,r){readStream(t,a,o,s,function(t,n){return t?r(t):void e(n)})})}function halt(t){unpipe(t),"function"==typeof t.pause&&t.pause()}function createError(t,e,r,n){var i=new Error;Error.captureStackTrace(i,createError);for(var a in n)i[a]=n[a];return i.message=e,i.status=t,i.statusCode=t,Object.defineProperty(i,"type",{value:r,enumerable:!0,writable:!0,configurable:!0}),i}function readStream(t,e,r,n,i){function f(){function n(){g(),e[0]&&halt(t),i.apply(null,e)}for(var e=new Array(arguments.length),r=0;r<e.length;r++)e[r]=arguments[r];a=!0,s?process.nextTick(n):n()}function p(){a||f(createError(400,"request aborted","request.aborted",{code:"ECONNABORTED",expected:r,length:r,received:h}))}function d(t){a||(h+=t.length,u?l+=u.write(t):l.push(t),null!==n&&h>n&&f(createError(413,"request entity too large","entity.too.large",{limit:n,received:h})))}function v(t){if(!a){if(t)return f(t);if(null!==r&&h!==r)f(createError(400,"request size did not match content length","request.size.invalid",{expected:r,length:r,received:h}));else{var e=u?l+(u.end()||""):Buffer.concat(l);f(null,e)}}}function g(){l=null,t.removeListener("aborted",p),t.removeListener("data",d),t.removeListener("end",v),t.removeListener("error",v),t.removeListener("close",g)}var a=!1,s=!0;if(null!==n&&null!==r&&r>n)return f(createError(413,"request entity too large","entity.too.large",{expected:r,length:r,limit:n}));var o=t._readableState;if(t._decoder||o&&(o.encoding||o.decoder))return f(createError(500,"stream encoding should not be set","stream.encoding.set"));var u,h=0;try{u=getDecoder(e)}catch(c){return f(c)}var l=u?"":[];t.on("aborted",p),t.on("close",g),t.on("data",d),t.on("end",v),t.on("error",v),s=!1}var bytes=require("bytes"),iconv=require("iconv-lite"),unpipe=require("unpipe");module.exports=getRawBody;var iconvEncodingMessageRegExp=/^Encoding not recognized: /;