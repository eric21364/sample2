"use strict";function read(t,e,r,i,n,s){var a,h,o=s;t._body=!0;var u=null!==o.encoding?o.encoding:null,c=o.verify;try{h=contentstream(t,n,o.inflate),a=h.length,h.length=void 0}catch(l){return r(l)}return o.length=a,o.encoding=c?null:u,null!==o.encoding||null===u||iconv.encodingExists(u)?(n("read body"),void getBody(h,o,function(s,a){if(s)return setErrorStatus(s,400),"encoding.unsupported"===s.type&&(s=createError(415,'unsupported charset "'+u.toUpperCase()+'"',{charset:u.toLowerCase()})),h.resume(),void onFinished(t,function(){r(s)});if(c)try{n("verify body"),c(t,e,a,u)}catch(s){return setErrorStatus(s,403),void r(s)}var o;try{n("parse body"),o="string"!=typeof a&&null!==u?iconv.decode(a,u):a,t.body=i(o)}catch(s){return s.body=void 0===o?a:o,setErrorStatus(s,400),void r(s)}r()})):r(createError(415,'unsupported charset "'+u.toUpperCase()+'"',{charset:u.toLowerCase()}))}function contentstream(t,e,r){var s,i=(t.headers["content-encoding"]||"identity").toLowerCase(),n=t.headers["content-length"];if(e('content-encoding "%s"',i),r===!1&&"identity"!==i)throw createError(415,"content encoding unsupported");switch(i){case"deflate":s=zlib.createInflate(),e("inflate body"),t.pipe(s);break;case"gzip":s=zlib.createGunzip(),e("gunzip body"),t.pipe(s);break;case"identity":s=t,s.length=n;break;default:throw createError(415,'unsupported content encoding "'+i+'"',{encoding:i})}return s}function setErrorStatus(t,e){t.status||t.statusCode||(t.status=e,t.statusCode=e)}var createError=require("http-errors"),getBody=require("raw-body"),iconv=require("iconv-lite"),onFinished=require("on-finished"),zlib=require("zlib");module.exports=read;