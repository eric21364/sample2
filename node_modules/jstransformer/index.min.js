"use strict";function normalizeFn(e){if("function"==typeof e)return{fn:e,dependencies:[]};if(e&&"object"==typeof e&&"function"==typeof e.fn){if("dependencies"in e){if(!Array.isArray(e.dependencies))throw new Error("Result should have a dependencies property that is an array")}else e.dependencies=[];return e}throw new Error("Invalid result object from transform.")}function normalizeFnAsync(e,t){return Promise.resolve(e).then(function(e){return e&&isPromise(e.fn)?e.fn.then(function(t){return e.fn=t,e}):e}).then(tr.normalizeFn).nodeify(t)}function normalize(e){if("string"==typeof e)return{body:e,dependencies:[]};if(e&&"object"==typeof e&&"string"==typeof e.body){if("dependencies"in e){if(!Array.isArray(e.dependencies))throw new Error("Result should have a dependencies property that is an array")}else e.dependencies=[];return e}throw new Error("Invalid result object from transform.")}function normalizeAsync(e,t){return Promise.resolve(e).then(function(e){return e&&isPromise(e.body)?e.body.then(function(t){return e.body=t,e}):e}).then(tr.normalize).nodeify(t)}function Transformer(e){assert(e,"Transformer must be an object"),assert("string"==typeof e.name,"Transformer must have a name"),assert("string"==typeof e.outputFormat,"Transformer must have an output format"),assert(["compile","compileAsync","compileFile","compileFileAsync","compileClient","compileClientAsync","compileFileClient","compileFileClientAsync","render","renderAsync","renderFile","renderFileAsync"].some(function(t){return"function"==typeof e[t]}),"Transformer must implement at least one of the potential methods."),this._tr=e,this.name=this._tr.name,this.outputFormat=this._tr.outputFormat,this.inputFormats=this._tr.inputFormats||[this.name]}var fs=require("fs"),assert=require("assert"),Promise=require("promise"),isPromise=require("is-promise"),tr=module.exports=function(e){return new Transformer(e)};tr.Transformer=Transformer,tr.normalizeFn=normalizeFn,tr.normalizeFnAsync=normalizeFnAsync,tr.normalize=normalize,tr.normalizeAsync=normalizeAsync,tr.readFile=Promise.denodeify(fs.readFile),tr.readFileSync=fs.readFileSync;var fallbacks={compile:["compile"],compileAsync:["compileAsync","compile"],compileFile:["compileFile","compile"],compileFileAsync:["compileFileAsync","compileFile","compileAsync","compile"],compileClient:["compileClient"],compileClientAsync:["compileClientAsync","compileClient"],compileFileClient:["compileFileClient","compileClient"],compileFileClientAsync:["compileFileClientAsync","compileFileClient","compileClientAsync","compileClient"],render:["render","compile"],renderAsync:["renderAsync","render","compileAsync","compile"],renderFile:["renderFile","render","compileFile","compile"],renderFileAsync:["renderFileAsync","renderFile","renderAsync","render","compileFileAsync","compileFile","compileAsync","compile"]};Transformer.prototype._hasMethod=function(e){return"function"==typeof this._tr[e]},Transformer.prototype.can=function(e){return fallbacks[e].some(function(e){return this._hasMethod(e)}.bind(this))},Transformer.prototype.compile=function(e,t){if(!this.can("compile"))throw this.can("compileAsync")?new Error('The Transform "'+this.name+'" does not support synchronous compilation'):this.can("compileFileAsync")?new Error('The Transform "'+this.name+'" does not support compiling plain strings'):new Error('The Transform "'+this.name+'" does not support compilation');return tr.normalizeFn(this._tr.compile(e,t))},Transformer.prototype.compileAsync=function(e,t,r){return this.can("compileAsync")?this._hasMethod("compileAsync")?tr.normalizeFnAsync(this._tr.compileAsync(e,t),r):tr.normalizeFnAsync(this._tr.compile(e,t),r):this.can("compileFileAsync")?Promise.reject(new Error('The Transform "'+this.name+'" does not support compiling plain strings')).nodeify(r):Promise.reject(new Error('The Transform "'+this.name+'" does not support compilation')).nodeify(r)},Transformer.prototype.compileFile=function(e,t){if(!this.can("compileFile"))throw this.can("compileFileAsync")?new Error('The Transform "'+this.name+'" does not support synchronous compilation'):new Error('The Transform "'+this.name+'" does not support compilation');return this._hasMethod("compileFile")?tr.normalizeFn(this._tr.compileFile(e,t)):tr.normalizeFn(this._tr.compile(tr.readFileSync(e,"utf8"),t))},Transformer.prototype.compileFileAsync=function(e,t,r){return this.can("compileFileAsync")?this._hasMethod("compileFileAsync")?tr.normalizeFnAsync(this._tr.compileFileAsync(e,t),r):this._hasMethod("compileFile")?tr.normalizeFnAsync(this._tr.compileFile(e,t),r):tr.normalizeFnAsync(tr.readFile(e,"utf8").then(function(e){return this._hasMethod("compileAsync")?this._tr.compileAsync(e,t):this._tr.compile(e,t)}.bind(this)),r):Promise.reject(new Error('The Transform "'+this.name+'" does not support compilation'))},Transformer.prototype.compileClient=function(e,t){if(!this.can("compileClient"))throw this.can("compileClientAsync")?new Error('The Transform "'+this.name+'" does not support compiling for the client synchronously.'):this.can("compileFileClientAsync")?new Error('The Transform "'+this.name+'" does not support compiling for the client from a string.'):new Error('The Transform "'+this.name+'" does not support compiling for the client');return tr.normalize(this._tr.compileClient(e,t))},Transformer.prototype.compileClientAsync=function(e,t,r){return this.can("compileClientAsync")?this._hasMethod("compileClientAsync")?tr.normalizeAsync(this._tr.compileClientAsync(e,t),r):tr.normalizeAsync(this._tr.compileClient(e,t),r):this.can("compileFileClientAsync")?Promise.reject(new Error('The Transform "'+this.name+'" does not support compiling for the client from a string.')).nodeify(r):Promise.reject(new Error('The Transform "'+this.name+'" does not support compiling for the client')).nodeify(r)},Transformer.prototype.compileFileClient=function(e,t){if(!this.can("compileFileClient"))throw this.can("compileFileClientAsync")?new Error('The Transform "'+this.name+'" does not support compiling for the client synchronously.'):new Error('The Transform "'+this.name+'" does not support compiling for the client');return this._hasMethod("compileFileClient")?tr.normalize(this._tr.compileFileClient(e,t)):tr.normalize(this._tr.compileClient(tr.readFileSync(e,"utf8"),t))},Transformer.prototype.compileFileClientAsync=function(e,t,r){return this.can("compileFileClientAsync")?this._hasMethod("compileFileClientAsync")?tr.normalizeAsync(this._tr.compileFileClientAsync(e,t),r):this._hasMethod("compileFileClient")?tr.normalizeAsync(this._tr.compileFileClient(e,t),r):tr.normalizeAsync(tr.readFile(e,"utf8").then(function(e){return this._hasMethod("compileClientAsync")?this._tr.compileClientAsync(e,t):this._tr.compileClient(e,t)}.bind(this)),r):Promise.reject(new Error('The Transform "'+this.name+'" does not support compiling for the client')).nodeify(r)},Transformer.prototype.render=function(e,t,r){if(!this.can("render"))throw this.can("renderAsync")?new Error('The Transform "'+this.name+'" does not support rendering synchronously.'):this.can("renderFileAsync")?new Error('The Transform "'+this.name+'" does not support rendering from a string.'):new Error('The Transform "'+this.name+'" does not support rendering');if(this._hasMethod("render"))return tr.normalize(this._tr.render(e,t,r));var n=tr.normalizeFn(this._tr.compile(e,t)),i=n.fn(t||r);if("string"!=typeof i)throw new Error('The Transform "'+this.name+'" does not support rendering synchronously.');return tr.normalize({body:i,dependencies:n.dependencies})},Transformer.prototype.renderAsync=function(e,t,r,n){return"function"==typeof r&&(n=r,r=t),this.can("renderAsync")?this._hasMethod("renderAsync")?tr.normalizeAsync(this._tr.renderAsync(e,t,r),n):this._hasMethod("render")?tr.normalizeAsync(this._tr.render(e,t,r),n):tr.normalizeAsync(this.compileAsync(e,t).then(function(e){return{body:e.fn(t||r),dependencies:e.dependencies}}),n):this.can("renderFileAsync")?Promise.reject(new Error('The Transform "'+this.name+'" does not support rendering from a string.')).nodeify(n):Promise.reject(new Error('The Transform "'+this.name+'" does not support rendering')).nodeify(n)},Transformer.prototype.renderFile=function(e,t,r){if("function"==typeof this._tr.renderFile)return tr.normalize(this._tr.renderFile(e,t,r));if("function"==typeof this._tr.render)return tr.normalize(this._tr.render(tr.readFileSync(e,"utf8"),t,r));if(this._hasMethod("compile")||this._hasMethod("compileFile")){var n=this.compileFile(e,t);return tr.normalize({body:n.fn(t||r),dependencies:n.dependencies})}return Promise.reject(new Error("This transform does not support synchronous rendering"))},Transformer.prototype.renderFileAsync=function(e,t,r,n){return"function"==typeof r&&(n=r,r=t),"function"==typeof this._tr.renderFileAsync?tr.normalizeAsync(this._tr.renderFileAsync(e,t,r),n):"function"==typeof this._tr.renderFile?tr.normalizeAsync(this._tr.renderFile(e,t,r),n):this._hasMethod("compile")||this._hasMethod("compileAsync")||this._hasMethod("compileFile")||this._hasMethod("compileFileAsync")?tr.normalizeAsync(this.compileFileAsync(e,t).then(function(e){return{body:e.fn(t||r),dependencies:e.dependencies}}),n):tr.normalizeAsync(tr.readFile(e,"utf8").then(function(e){return this.renderAsync(e,t,r)}.bind(this)),n)};