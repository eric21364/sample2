!function(){"use strict";Konva.DD={anim:new Konva.Animation(function(){var e=this.dirty;return this.dirty=!1,e}),isDragging:!1,justDragged:!1,offset:{x:0,y:0},node:null,_drag:function(e){var t=Konva.DD,r=t.node;if(r){if(!t.isDragging){var i=r.getStage().getPointerPosition(),n=r.dragDistance(),s=Math.max(Math.abs(i.x-t.startPointerPos.x),Math.abs(i.y-t.startPointerPos.y));if(n>s)return}r.getStage()._setPointerPosition(e),r._setDragPosition(e),t.isDragging||(t.isDragging=!0,r.fire("dragstart",{type:"dragstart",target:r,evt:e},!0)),r.fire("dragmove",{type:"dragmove",target:r,evt:e},!0)}},_endDragBefore:function(e){var i,t=Konva.DD,r=t.node;r&&(i=r.getLayer(),t.anim.stop(),t.isDragging&&(t.isDragging=!1,t.justDragged=!0,Konva.listenClickTap=!1,e&&(e.dragEndNode=r)),delete t.node,(r.getLayer()||i||r instanceof Konva.Stage)&&(i||r).draw())},_endDragAfter:function(e){e=e||{};var t=e.dragEndNode;e&&t&&t.fire("dragend",{type:"dragend",target:t,evt:e},!0)}},Konva.Node.prototype.startDrag=function(){var e=Konva.DD,t=this.getStage(),r=this.getLayer(),i=t.getPointerPosition(),n=this.getAbsolutePosition();i&&(e.node&&e.node.stopDrag(),e.node=this,e.startPointerPos=i,e.offset.x=i.x-n.x,e.offset.y=i.y-n.y,e.anim.setLayers(r||this.getLayers()),e.anim.start(),this._setDragPosition())},Konva.Node.prototype._setDragPosition=function(e){var t=Konva.DD,r=this.getStage().getPointerPosition(),i=this.getDragBoundFunc();if(r){var n={x:r.x-t.offset.x,y:r.y-t.offset.y};void 0!==i&&(n=i.call(this,n,e)),this.setAbsolutePosition(n),this._lastPos&&this._lastPos.x===n.x&&this._lastPos.y===n.y||(t.anim.dirty=!0),this._lastPos=n}},Konva.Node.prototype.stopDrag=function(){var e=Konva.DD,t={};e._endDragBefore(t),e._endDragAfter(t)},Konva.Node.prototype.setDraggable=function(e){this._setAttr("draggable",e),this._dragChange()};var e=Konva.Node.prototype.remove;Konva.Node.prototype.__originalRemove=e,Konva.Node.prototype.remove=function(){var t=Konva.DD;t.node&&t.node._id===this._id&&this.stopDrag(),e.call(this)},Konva.Node.prototype.isDragging=function(){var e=Konva.DD;return!(!e.node||e.node._id!==this._id||!e.isDragging)},Konva.Node.prototype._listenDrag=function(){var e=this;this._dragCleanup(),"Stage"===this.getClassName()?this.on("contentMousedown.konva contentTouchstart.konva",function(t){Konva.DD.node||e.startDrag(t)}):this.on("mousedown.konva touchstart.konva",function(t){1!==t.evt.button&&2!==t.evt.button&&(Konva.DD.node||e.startDrag(t))})},Konva.Node.prototype._dragChange=function(){if(this.attrs.draggable)this._listenDrag();else{this._dragCleanup();var e=this.getStage(),t=Konva.DD;e&&t.node&&t.node._id===this._id&&t.node.stopDrag()}},Konva.Node.prototype._dragCleanup=function(){"Stage"===this.getClassName()?(this.off("contentMousedown.konva"),this.off("contentTouchstart.konva")):(this.off("mousedown.konva"),this.off("touchstart.konva"))},Konva.Factory.addGetterSetter(Konva.Node,"dragBoundFunc"),Konva.Factory.addGetter(Konva.Node,"draggable",!1),Konva.Factory.addOverloadedGetterSetter(Konva.Node,"draggable");var t=Konva.document.documentElement;t.addEventListener("mouseup",Konva.DD._endDragBefore,!0),t.addEventListener("touchend",Konva.DD._endDragBefore,!0),t.addEventListener("mousemove",Konva.DD._drag),t.addEventListener("touchmove",Konva.DD._drag),t.addEventListener("mouseup",Konva.DD._endDragAfter,!1),t.addEventListener("touchend",Konva.DD._endDragAfter,!1)}();