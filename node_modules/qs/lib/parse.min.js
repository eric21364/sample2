"use strict";var utils=require("./utils"),has=Object.prototype.hasOwnProperty,defaults={allowDots:!1,allowPrototypes:!1,arrayLimit:20,decoder:utils.decode,delimiter:"&",depth:5,parameterLimit:1e3,plainObjects:!1,strictNullHandling:!1},parseValues=function(e,t){for(var r={},i=e.split(t.delimiter,t.parameterLimit===1/0?void 0:t.parameterLimit),n=0;n<i.length;++n){var o,u,s=i[n],a=-1===s.indexOf("]=")?s.indexOf("="):s.indexOf("]=")+1;-1===a?(o=t.decoder(s),u=t.strictNullHandling?null:""):(o=t.decoder(s.slice(0,a)),u=t.decoder(s.slice(a+1))),has.call(r,o)?r[o]=[].concat(r[o]).concat(u):r[o]=u}return r},parseObject=function(e,t,r){if(!e.length)return t;var n,i=e.shift();if("[]"===i)n=[],n=n.concat(parseObject(e,t,r));else{n=r.plainObjects?Object.create(null):{};var s="["===i.charAt(0)&&"]"===i.charAt(i.length-1)?i.slice(1,-1):i,a=parseInt(s,10);!isNaN(a)&&i!==s&&String(a)===s&&a>=0&&r.parseArrays&&a<=r.arrayLimit?(n=[],n[a]=parseObject(e,t,r)):n[s]=parseObject(e,t,r)}return n},parseKeys=function(e,t,r){if(e){var i=r.allowDots?e.replace(/\.([^.[]+)/g,"[$1]"):e,n=/(\[[^[\]]*])/,s=/(\[[^[\]]*])/g,a=n.exec(i),o=a?i.slice(0,a.index):i,u=[];if(o){if(!r.plainObjects&&has.call(Object.prototype,o)&&!r.allowPrototypes)return;u.push(o)}for(var c=0;null!==(a=s.exec(i))&&c<r.depth;){if(c+=1,!r.plainObjects&&has.call(Object.prototype,a[1].slice(1,-1))&&!r.allowPrototypes)return;u.push(a[1])}return a&&u.push("["+i.slice(a.index)+"]"),parseObject(u,t,r)}};module.exports=function(e,t){var r=t||{};if(null!==r.decoder&&void 0!==r.decoder&&"function"!=typeof r.decoder)throw new TypeError("Decoder has to be a function.");if(r.delimiter="string"==typeof r.delimiter||utils.isRegExp(r.delimiter)?r.delimiter:defaults.delimiter,r.depth="number"==typeof r.depth?r.depth:defaults.depth,r.arrayLimit="number"==typeof r.arrayLimit?r.arrayLimit:defaults.arrayLimit,r.parseArrays=r.parseArrays!==!1,r.decoder="function"==typeof r.decoder?r.decoder:defaults.decoder,r.allowDots="boolean"==typeof r.allowDots?r.allowDots:defaults.allowDots,r.plainObjects="boolean"==typeof r.plainObjects?r.plainObjects:defaults.plainObjects,r.allowPrototypes="boolean"==typeof r.allowPrototypes?r.allowPrototypes:defaults.allowPrototypes,r.parameterLimit="number"==typeof r.parameterLimit?r.parameterLimit:defaults.parameterLimit,r.strictNullHandling="boolean"==typeof r.strictNullHandling?r.strictNullHandling:defaults.strictNullHandling,""===e||null===e||"undefined"==typeof e)return r.plainObjects?Object.create(null):{};for(var i="string"==typeof e?parseValues(e,r):e,n=r.plainObjects?Object.create(null):{},s=Object.keys(i),a=0;a<s.length;++a){var o=s[a],u=parseKeys(o,i[o],r);n=utils.merge(n,u,r)}return utils.compact(n)};