function Connection(e){Events.EventEmitter.call(this),this.config=e.config,this._socket=e.socket,this._protocol=new Protocol({config:this.config,connection:this}),this._connectCalled=!1,this.state="disconnected",this.threadId=null}function bindToCurrentDomain(e){if(!e)return void 0;var t=process.domain;return t?t.bind(e):e}var Crypto=require("crypto"),Events=require("events"),Net=require("net"),tls=require("tls"),ConnectionConfig=require("./ConnectionConfig"),Protocol=require("./protocol/Protocol"),SqlString=require("./protocol/SqlString"),Query=require("./protocol/sequences/Query"),Util=require("util");module.exports=Connection,Util.inherits(Connection,Events.EventEmitter),Connection.createQuery=function(e,t,r){if(e instanceof Query)return e;var i=bindToCurrentDomain(r),n={};if("function"==typeof e)return i=bindToCurrentDomain(e),new Query(n,i);if("object"==typeof e){for(var s in e)n[s]=e[s];return"function"==typeof t?i=bindToCurrentDomain(t):void 0!==t&&(n.values=t),new Query(n,i)}if(n.sql=e,n.values=t,"function"==typeof t&&(i=bindToCurrentDomain(t),n.values=void 0),void 0===i&&void 0!==r)throw new TypeError("argument callback must be a function when provided");return new Query(n,i)},Connection.prototype.connect=function(e,t){if(t||"function"!=typeof e||(t=e,e={}),!this._connectCalled){this._connectCalled=!0,this._socket=this.config.socketPath?Net.createConnection(this.config.socketPath):Net.createConnection(this.config.port,this.config.host),Events.usingDomains&&(this._socket.domain=this.domain);var r=this;if(this._protocol.on("data",function(e){r._socket.write(e)}),this._socket.on("data",function(e){r._protocol.write(e)}),this._protocol.on("end",function(){r._socket.end()}),this._socket.on("end",function(){r._protocol.end()}),this._socket.on("error",this._handleNetworkError.bind(this)),this._socket.on("connect",this._handleProtocolConnect.bind(this)),this._protocol.on("handshake",this._handleProtocolHandshake.bind(this)),this._protocol.on("unhandledError",this._handleProtocolError.bind(this)),this._protocol.on("drain",this._handleProtocolDrain.bind(this)),this._protocol.on("end",this._handleProtocolEnd.bind(this)),this._protocol.on("enqueue",this._handleProtocolEnqueue.bind(this)),this.config.connectTimeout){var i=this._handleConnectTimeout.bind(this);this._socket.setTimeout(this.config.connectTimeout,i),this._socket.once("connect",function(){this.setTimeout(0,i)})}}this._protocol.handshake(e,bindToCurrentDomain(t))},Connection.prototype.changeUser=function(e,t){t||"function"!=typeof e||(t=e,e={}),this._implyConnect();var r=e.charset?ConnectionConfig.getCharsetNumber(e.charset):this.config.charsetNumber;return this._protocol.changeUser({user:e.user||this.config.user,password:e.password||this.config.password,database:e.database||this.config.database,timeout:e.timeout,charsetNumber:r,currentConfig:this.config},bindToCurrentDomain(t))},Connection.prototype.beginTransaction=function(e,t){return t||"function"!=typeof e||(t=e,e={}),e=e||{},e.sql="START TRANSACTION",e.values=null,this.query(e,t)},Connection.prototype.commit=function(e,t){return t||"function"!=typeof e||(t=e,e={}),e=e||{},e.sql="COMMIT",e.values=null,this.query(e,t)},Connection.prototype.rollback=function(e,t){return t||"function"!=typeof e||(t=e,e={}),e=e||{},e.sql="ROLLBACK",e.values=null,this.query(e,t)},Connection.prototype.query=function a(e,t,r){var a=Connection.createQuery(e,t,r);return a._connection=this,"object"==typeof e&&"typeCast"in e||(a.typeCast=this.config.typeCast),a.sql&&(a.sql=this.format(a.sql,a.values)),this._implyConnect(),this._protocol._enqueue(a)},Connection.prototype.ping=function(e,t){t||"function"!=typeof e||(t=e,e={}),this._implyConnect(),this._protocol.ping(e,bindToCurrentDomain(t))},Connection.prototype.statistics=function(e,t){t||"function"!=typeof e||(t=e,e={}),this._implyConnect(),this._protocol.stats(e,bindToCurrentDomain(t))},Connection.prototype.end=function(e,t){var r=t,i=e;t||"function"!=typeof e||(r=e,i=null),i=Object.create(i||null),void 0===i.timeout&&(i.timeout=3e4),this._implyConnect(),this._protocol.quit(i,bindToCurrentDomain(r))},Connection.prototype.destroy=function(){this.state="disconnected",this._implyConnect(),this._socket.destroy(),this._protocol.destroy()},Connection.prototype.pause=function(){this._socket.pause(),this._protocol.pause()},Connection.prototype.resume=function(){this._socket.resume(),this._protocol.resume()},Connection.prototype.escape=function(e){return SqlString.escape(e,!1,this.config.timezone)},Connection.prototype.escapeId=function(e){return SqlString.escapeId(e,!1)},Connection.prototype.format=function(e,t){return"function"==typeof this.config.queryFormat?this.config.queryFormat.call(this,e,t,this.config.timezone):SqlString.format(e,t,this.config.stringifyObjects,this.config.timezone)},tls.TLSSocket?Connection.prototype._startTLS=function(e){var t=this,r=tls.createSecureContext({ca:this.config.ssl.ca,cert:this.config.ssl.cert,ciphers:this.config.ssl.ciphers,key:this.config.ssl.key,passphrase:this.config.ssl.passphrase});this._socket.removeAllListeners("data"),this._protocol.removeAllListeners("data");var i=this.config.ssl.rejectUnauthorized,n=!1,s=new tls.TLSSocket(this._socket,{rejectUnauthorized:i,requestCert:!0,secureContext:r,isServer:!1});s.on("_tlsError",function(r){n?t._handleNetworkError(r):e(r)}),s.pipe(this._protocol),this._protocol.on("data",function(e){s.write(e)}),s.on("secure",function(){n=!0,e(i?this.ssl.verifyError():null)}),s._start()}:Connection.prototype._startTLS=function(e){var t=this,r=Crypto.createCredentials({ca:this.config.ssl.ca,cert:this.config.ssl.cert,ciphers:this.config.ssl.ciphers,key:this.config.ssl.key,passphrase:this.config.ssl.passphrase}),i=this.config.ssl.rejectUnauthorized,n=!1,s=tls.createSecurePair(r,!1,!0,i);s.on("error",function(r){n?t._handleNetworkError(r):e(r)}),this._socket.removeAllListeners("data"),this._protocol.removeAllListeners("data"),s.encrypted.pipe(this._socket),this._socket.on("data",function(e){s.encrypted.write(e)}),s.cleartext.pipe(this._protocol),this._protocol.on("data",function(e){s.cleartext.write(e)}),s.on("secure",function(){if(n=!0,!i)return void e();var t=this.ssl.verifyError(),r=t;"string"==typeof r&&(r=new Error(t),r.code=t),e(r)}),s._cycle=s.cycle,s.cycle=function(){return this.ssl&&this.ssl.error&&this.error(),this._cycle.apply(this,arguments)}},Connection.prototype._handleConnectTimeout=function(){this._socket&&(this._socket.setTimeout(0),this._socket.destroy());var e=new Error("connect ETIMEDOUT");e.errorno="ETIMEDOUT",e.code="ETIMEDOUT",e.syscall="connect",this._handleNetworkError(e)},Connection.prototype._handleNetworkError=function(e){this._protocol.handleNetworkError(e)},Connection.prototype._handleProtocolError=function(e){this.state="protocol_error",this.emit("error",e)},Connection.prototype._handleProtocolDrain=function(){this.emit("drain")},Connection.prototype._handleProtocolConnect=function(){this.state="connected",this.emit("connect")},Connection.prototype._handleProtocolHandshake=function(e){this.state="authenticated",this.threadId=e.threadId},Connection.prototype._handleProtocolEnd=function(e){this.state="disconnected",this.emit("end",e)},Connection.prototype._handleProtocolEnqueue=function(e){this.emit("enqueue",e)},Connection.prototype._implyConnect=function(){this._connectCalled||this.connect()};