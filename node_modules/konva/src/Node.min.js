!function(e){"use strict";var t="absoluteOpacity",r="absoluteTransform",i="absoluteScale",n="Change",s="children",a=".",o="",h="get",c="id",u="konva",l="listening",f="mouseenter",p="mouseleave",d="name",v="set",g="Shape",m=" ",y="stage",b="transform",x="Stage",w="visible",S=["id"],_=["xChange.konva","yChange.konva","scaleXChange.konva","scaleYChange.konva","skewXChange.konva","skewYChange.konva","rotationChange.konva","offsetXChange.konva","offsetYChange.konva","transformsEnabledChange.konva"].join(m),k=["scaleXChange.konva","scaleYChange.konva"].join(m);e.Node=function(e){this._init(e)},e.Util.addMethods(e.Node,{_init:function(n){var s=this;this._id=e.idCounter++,this.eventListeners={},this.attrs={},this._cache={},this._filterUpToDate=!1,this._isUnderCache=!1,this.setAttrs(n),this.on(_,function(){this._clearCache(b),s._clearSelfAndDescendantCache(r)}),this.on(k,function(){s._clearSelfAndDescendantCache(i)}),this.on("visibleChange.konva",function(){s._clearSelfAndDescendantCache(w)}),this.on("listeningChange.konva",function(){s._clearSelfAndDescendantCache(l)}),this.on("opacityChange.konva",function(){s._clearSelfAndDescendantCache(t)})},_clearCache:function(e){e?delete this._cache[e]:this._cache={}},_getCache:function(e,t){var r=this._cache[e];return void 0===r&&(this._cache[e]=t.call(this)),this._cache[e]},_clearSelfAndDescendantCache:function(e){this._clearCache(e),this.children&&this.getChildren().each(function(t){t._clearSelfAndDescendantCache(e)})},clearCache:function(){return delete this._cache.canvas,this._filterUpToDate=!1,this},cache:function(r){var n=r||{},s=this.getClientRect(!0),a=n.width||s.width,o=n.height||s.height,h=n.pixelRatio,c=n.x||s.x,u=n.y||s.y,l=n.offset||0,f=n.drawBorder||!1;if(!a||!o)throw new Error("Width or height of caching configuration equals 0.");a+=2*l,o+=2*l,c-=l,u-=l;var p=new e.SceneCanvas({pixelRatio:h,width:a,height:o}),d=new e.SceneCanvas({pixelRatio:h,width:a,height:o}),v=new e.HitCanvas({pixelRatio:1,width:a,height:o}),g=p.getContext(),m=v.getContext();return v.isCache=!0,this.clearCache(),g.save(),m.save(),g.translate(-c,-u),m.translate(-c,-u),this._isUnderCache=!0,this._clearSelfAndDescendantCache(t),this._clearSelfAndDescendantCache(i),this.drawScene(p,this,!0),this.drawHit(v,this,!0),this._isUnderCache=!1,g.restore(),m.restore(),f&&(g.save(),g.beginPath(),g.rect(0,0,a,o),g.closePath(),g.setAttr("strokeStyle","red"),g.setAttr("lineWidth",5),g.stroke(),g.restore()),this._cache.canvas={scene:p,filter:d,hit:v,x:c,y:u},this},getClientRect:function(){throw new Error('abstract "getClientRect" method call')},_transformedRect:function(e){var r,i,n,s,t=[{x:e.x,y:e.y},{x:e.x+e.width,y:e.y},{x:e.x+e.width,y:e.y+e.height},{x:e.x,y:e.y+e.height}],a=this.getTransform();return t.forEach(function(e){var t=a.point(e);void 0===r&&(r=n=t.x,i=s=t.y),r=Math.min(r,t.x),i=Math.min(i,t.y),n=Math.max(n,t.x),s=Math.max(s,t.y)}),{x:r,y:i,width:n-r,height:s-i}},_drawCachedSceneCanvas:function(e){e.save(),e._applyOpacity(this),e._applyGlobalCompositeOperation(this),e.translate(this._cache.canvas.x,this._cache.canvas.y);var t=this._getCachedSceneCanvas(),r=t.pixelRatio;e.drawImage(t._canvas,0,0,t.width/r,t.height/r),e.restore()},_drawCachedHitCanvas:function(e){var t=this._cache.canvas,r=t.hit;e.save(),e.translate(this._cache.canvas.x,this._cache.canvas.y),e.drawImage(r._canvas,0,0),e.restore()},_getCachedSceneCanvas:function(){var a,o,h,c,t=this.filters(),r=this._cache.canvas,i=r.scene,n=r.filter,s=n.getContext();if(t){if(!this._filterUpToDate){var u=i.pixelRatio;try{for(a=t.length,s.clear(),s.drawImage(i._canvas,0,0,i.getWidth()/u,i.getHeight()/u),o=s.getImageData(0,0,n.getWidth(),n.getHeight()),h=0;a>h;h++)c=t[h],"function"==typeof c?(c.call(this,o),s.putImageData(o,0,0)):e.Util.error("Filter should be type of function, but got "+typeof c+" insted. Please check correct filters")}catch(l){e.Util.error("Unable to apply filter. "+l.message)}this._filterUpToDate=!0}return n}return i},on:function(e,t){if(3===arguments.length)return this._delegate.apply(this,arguments);var n,s,h,c,u,r=e.split(m),i=r.length;for(n=0;i>n;n++)s=r[n],h=s.split(a),c=h[0],u=h[1]||o,this.eventListeners[c]||(this.eventListeners[c]=[]),this.eventListeners[c].push({name:u,handler:t});return this},off:function(e){var i,n,s,o,h,c,t=(e||"").split(m),r=t.length;if(!e)for(n in this.eventListeners)this._off(n);for(i=0;r>i;i++)if(s=t[i],o=s.split(a),h=o[0],c=o[1],h)this.eventListeners[h]&&this._off(h,c);else for(n in this.eventListeners)this._off(n,c);return this},dispatchEvent:function(e){var t={target:this,type:e.type,evt:e};return this.fire(e.type,t),this},addEventListener:function(e,t){return this.on(e,function(e){t.call(this,e.evt)}),this},removeEventListener:function(e){return this.off(e),this},_delegate:function(t,r,i){var n=this;this.on(t,function(t){for(var s=t.target.findAncestors(r,!0,n),a=0;a<s.length;a++)t=e.Util.cloneObject(t),t.currentTarget=s[a],i.call(s[a],t)})},remove:function(){var e=this.getParent();return e&&e.children&&(e.children.splice(this.index,1),e._setChildrenIndices(),delete this.parent),this._clearSelfAndDescendantCache(y),this._clearSelfAndDescendantCache(r),this._clearSelfAndDescendantCache(w),this._clearSelfAndDescendantCache(l),this._clearSelfAndDescendantCache(t),this},destroy:function(){e._removeId(this.getId());for(var t=(this.getName()||"").split(/\s/g),r=0;r<t.length;r++){var i=t[r];e._removeName(i,this._id)}return this.remove(),this},getAttr:function(t){var r=h+e.Util._capitalize(t);return e.Util._isFunction(this[r])?this[r]():this.attrs[t]},getAncestors:function(){for(var t=this.getParent(),r=new e.Collection;t;)r.push(t),t=t.getParent();return r},getAttrs:function(){return this.attrs||{}},setAttrs:function(t){var r,i;if(!t)return this;for(r in t)r!==s&&(i=v+e.Util._capitalize(r),e.Util._isFunction(this[i])?this[i](t[r]):this._setAttr(r,t[r]));return this},isListening:function(){return this._getCache(l,this._isListening)},_isListening:function(){var e=this.getListening(),t=this.getParent();return"inherit"===e?t?t.isListening():!0:e},isVisible:function(){return this._getCache(w,this._isVisible)},_isVisible:function(){var e=this.getVisible(),t=this.getParent();return"inherit"===e?t?t.isVisible():!0:e},shouldDrawHit:function(e){var t=this.getLayer();return e&&e.isCache||t&&t.hitGraphEnabled()&&this.isListening()&&this.isVisible()},show:function(){return this.setVisible(!0),this},hide:function(){return this.setVisible(!1),this},getZIndex:function(){return this.index||0},getAbsoluteZIndex:function(){function o(h){for(i=[],n=h.length,s=0;n>s;s++)a=h[s],r++,a.nodeType!==g&&(i=i.concat(a.getChildren().toArray())),a._id===t._id&&(s=n);i.length>0&&i[0].getDepth()<=e&&o(i)}var i,n,s,a,e=this.getDepth(),t=this,r=0;return t.nodeType!==x&&o(t.getStage().getChildren()),r},getDepth:function(){for(var e=0,t=this.parent;t;)e++,t=t.parent;return e},setPosition:function(e){return this.setX(e.x),this.setY(e.y),this},getPosition:function(){return{x:this.getX(),y:this.getY()}},getAbsolutePosition:function(t){var r=this.getAbsoluteTransform(t).getMatrix(),i=new e.Transform,n=this.offset();return i.m=r.slice(),i.translate(n.x,n.y),i.getTranslation()},setAbsolutePosition:function(e){var r,t=this._clearTransform();return this.attrs.x=t.x,this.attrs.y=t.y,delete t.x,delete t.y,r=this.getAbsoluteTransform(),r.invert(),r.translate(e.x,e.y),e={x:this.attrs.x+r.getTranslation().x,y:this.attrs.y+r.getTranslation().y},this.setPosition({x:e.x,y:e.y}),this._setTransform(t),this},_setTransform:function(e){var t;for(t in e)this.attrs[t]=e[t];this._clearCache(b),this._clearSelfAndDescendantCache(r)},_clearTransform:function(){var e={x:this.getX(),y:this.getY(),rotation:this.getRotation(),scaleX:this.getScaleX(),scaleY:this.getScaleY(),offsetX:this.getOffsetX(),offsetY:this.getOffsetY(),skewX:this.getSkewX(),skewY:this.getSkewY()};return this.attrs.x=0,this.attrs.y=0,this.attrs.rotation=0,this.attrs.scaleX=1,this.attrs.scaleY=1,this.attrs.offsetX=0,this.attrs.offsetY=0,this.attrs.skewX=0,this.attrs.skewY=0,this._clearCache(b),this._clearSelfAndDescendantCache(r),e},move:function(e){var t=e.x,r=e.y,i=this.getX(),n=this.getY();return void 0!==t&&(i+=t),void 0!==r&&(n+=r),this.setPosition({x:i,y:n}),this},_eachAncestorReverse:function(e,t){var n,s,r=[],i=this.getParent();if(t&&t._id===this._id)return e(this),!0;for(r.unshift(this);i&&(!t||i._id!==t._id);)r.unshift(i),i=i.parent;for(n=r.length,s=0;n>s;s++)e(r[s])},rotate:function(e){return this.setRotation(this.getRotation()+e),this},moveToTop:function(){if(!this.parent)return e.Util.warn("Node has no parent. moveToTop function is ignored."),!1;var t=this.index;return this.parent.children.splice(t,1),this.parent.children.push(this),this.parent._setChildrenIndices(),!0},moveUp:function(){if(!this.parent)return e.Util.warn("Node has no parent. moveUp function is ignored."),!1;var t=this.index,r=this.parent.getChildren().length;return r-1>t?(this.parent.children.splice(t,1),this.parent.children.splice(t+1,0,this),this.parent._setChildrenIndices(),!0):!1},moveDown:function(){if(!this.parent)return e.Util.warn("Node has no parent. moveDown function is ignored."),!1;var t=this.index;return t>0?(this.parent.children.splice(t,1),this.parent.children.splice(t-1,0,this),this.parent._setChildrenIndices(),!0):!1},moveToBottom:function(){if(!this.parent)return e.Util.warn("Node has no parent. moveToBottom function is ignored."),!1;var t=this.index;return t>0?(this.parent.children.splice(t,1),this.parent.children.unshift(this),this.parent._setChildrenIndices(),!0):!1},setZIndex:function(t){if(!this.parent)return e.Util.warn("Node has no parent. zIndex parameter is ignored."),!1;var r=this.index;return this.parent.children.splice(r,1),this.parent.children.splice(t,0,this),this.parent._setChildrenIndices(),this},getAbsoluteOpacity:function(){return this._getCache(t,this._getAbsoluteOpacity)},_getAbsoluteOpacity:function(){var e=this.getOpacity(),t=this.getParent();return t&&!t._isUnderCache&&(e*=this.getParent().getAbsoluteOpacity()),e},moveTo:function(e){return this.getParent()!==e&&((this.__originalRemove||this.remove).call(this),e.add(this)),this},toObject:function(){var i,n,s,a,t={},r=this.getAttrs();t.attrs={};for(i in r)n=r[i],s=this[i],delete r[i],a=s?s.call(this):null,r[i]=n,a!==n&&(t.attrs[i]=n);return t.className=this.getClassName(),e.Util._prepareToStringify(t)},toJSON:function(){return JSON.stringify(this.toObject())},getParent:function(){return this.parent},findAncestors:function(e,t,r){var i=[];t&&this._isMatch(e)&&i.push(this);for(var n=this.parent;n;){if(n===r)return i;n._isMatch(e)&&i.push(n),n=n.parent}return i},findAncestor:function(e,t,r){return this.findAncestors(e,t,r)[0]},_isMatch:function(t){if(!t)return!1;var n,s,r=t.replace(/ /g,"").split(","),i=r.length;for(n=0;i>n;n++)if(s=r[n],e.Util.isValidSelector(s)||(e.Util.warn('Selector "'+s+'" is invalid. Allowed selectors examples are "#foo", ".bar" or "Group".'),e.Util.warn('If you have a custom shape with such className, please change it to start with upper letter like "Triangle".'),e.Util.warn("Konva is awesome, right?")),"#"===s.charAt(0)){if(this.id()===s.slice(1))return!0}else if("."===s.charAt(0)){if(this.hasName(s.slice(1)))return!0}else if(0!==this._get(s).length)return!0;return!1},getLayer:function(){var e=this.getParent();return e?e.getLayer():null},getStage:function(){return this._getCache(y,this._getStage)},_getStage:function(){var e=this.getParent();return e?e.getStage():void 0},fire:function(e,t,r){return t=t||{},t.target=t.target||this,r?this._fireAndBubble(e,t):this._fire(e,t),this},getAbsoluteTransform:function(e){return e?this._getAbsoluteTransform(e):this._getCache(r,this._getAbsoluteTransform)},_getAbsoluteTransform:function(t){var i,n,r=new e.Transform;return this._eachAncestorReverse(function(e){i=e.transformsEnabled(),n=e.getTransform(),"all"===i?r.multiply(n):"position"===i&&r.translate(e.x(),e.y())},t),r},getAbsoluteScale:function(e){return e?this._getAbsoluteTransform(e):this._getCache(i,this._getAbsoluteScale)},_getAbsoluteScale:function(e){for(var t=this;t;)t._isUnderCache&&(e=t),t=t.getParent();var r=1,i=1;return this._eachAncestorReverse(function(e){r*=e.scaleX(),i*=e.scaleY()},e),{x:r,y:i}},getTransform:function(){return this._getCache(b,this._getTransform)},_getTransform:function(){var t=new e.Transform,r=this.getX(),i=this.getY(),n=e.getAngle(this.getRotation()),s=this.getScaleX(),a=this.getScaleY(),o=this.getSkewX(),h=this.getSkewY(),c=this.getOffsetX(),u=this.getOffsetY();return(0!==r||0!==i)&&t.translate(r,i),0!==n&&t.rotate(n),(0!==o||0!==h)&&t.skew(o,h),(1!==s||1!==a)&&t.scale(s,a),(0!==c||0!==u)&&t.translate(-1*c,-1*u),t},clone:function(t){var i,n,s,a,o,r=e.Util.cloneObject(this.attrs);for(var h in S){var c=S[h];delete r[c]}for(i in t)r[i]=t[i];var l=new this.constructor(r);for(i in this.eventListeners)for(n=this.eventListeners[i],s=n.length,a=0;s>a;a++)o=n[a],o.name.indexOf(u)<0&&(l.eventListeners[i]||(l.eventListeners[i]=[]),l.eventListeners[i].push(o));return l},_toKonvaCanvas:function(t){t=t||{};var r=this.getStage(),i=t.x||0,n=t.y||0,s=t.pixelRatio||1,a=new e.SceneCanvas({width:t.width||this.getWidth()||(r?r.getWidth():0),height:t.height||this.getHeight()||(r?r.getHeight():0),pixelRatio:s}),o=a.getContext();return o.save(),(i||n)&&o.translate(-1*i,-1*n),this.drawScene(a),o.restore(),a},toCanvas:function(e){return this._toKonvaCanvas(e)._canvas},toDataURL:function(e){e=e||{};var t=e.mimeType||null,r=e.quality||null;return this._toKonvaCanvas(e).toDataURL(t,r)},toImage:function(t){if(!t||!t.callback)throw"callback required for toImage method config argument";e.Util._getImage(this.toDataURL(t),function(e){t.callback(e)})},setSize:function(e){return this.setWidth(e.width),this.setHeight(e.height),this},getSize:function(){return{width:this.getWidth(),height:this.getHeight()}},getWidth:function(){return this.attrs.width||0},getHeight:function(){return this.attrs.height||0},getClassName:function(){return this.className||this.nodeType},getType:function(){return this.nodeType},getDragDistance:function(){return void 0!==this.attrs.dragDistance?this.attrs.dragDistance:this.parent?this.parent.getDragDistance():e.dragDistance},_get:function(e){return this.className===e||this.nodeType===e?[this]:[]},_off:function(e,t){var i,n,r=this.eventListeners[e];for(i=0;i<r.length;i++)if(n=r[i].name,!("konva"===n&&"konva"!==t||t&&n!==t)){if(r.splice(i,1),0===r.length){delete this.eventListeners[e];break}i--}},_fireChangeEvent:function(e,t,r){this._fire(e+n,{oldVal:t,newVal:r})},setId:function(t){var r=this.getId();return e._removeId(r),e._addId(this,t),this._setAttr(c,t),this},setName:function(t){var n,s,r=(this.getName()||"").split(/\s/g),i=(t||"").split(/\s/g);for(s=0;s<r.length;s++)n=r[s],-1===i.indexOf(n)&&n&&e._removeName(n,this._id);for(s=0;s<i.length;s++)n=i[s],-1===r.indexOf(n)&&n&&e._addName(this,n);return this._setAttr(d,t),this},addName:function(e){if(!this.hasName(e)){var t=this.name(),r=t?t+" "+e:e;this.setName(r)}return this},hasName:function(e){var t=(this.name()||"").split(/\s/g);return-1!==t.indexOf(e)},removeName:function(e){var t=(this.name()||"").split(/\s/g),r=t.indexOf(e);return-1!==r&&(t.splice(r,1),this.setName(t.join(" "))),this},setAttr:function(t,r){var i=v+e.Util._capitalize(t),n=this[i];return e.Util._isFunction(n)?n.call(this,r):this._setAttr(t,r),this},_setAttr:function(e,t){var r;r=this.attrs[e],r!==t&&(void 0===t||null===t?delete this.attrs[e]:this.attrs[e]=t,this._fireChangeEvent(e,r,t))},_setComponentAttr:function(e,t,r){var i;void 0!==r&&(i=this.attrs[e],i||(this.attrs[e]=this.getAttr(e)),this.attrs[e][t]=r,this._fireChangeEvent(e,i,r))},_fireAndBubble:function(e,t,r){var i=!0;if(t&&this.nodeType===g&&(t.target=this),e===f&&r&&(this._id===r._id||this.isAncestorOf&&this.isAncestorOf(r))?i=!1:e===p&&r&&(this._id===r._id||this.isAncestorOf&&this.isAncestorOf(r))&&(i=!1),i){this._fire(e,t);var n=(e===f||e===p)&&r&&r.isAncestorOf&&r.isAncestorOf(this)&&!r.isAncestorOf(this.parent);(t&&!t.cancelBubble||!t)&&this.parent&&this.parent.isListening()&&!n&&(r&&r.parent?this._fireAndBubble.call(this.parent,e,t,r.parent):this._fireAndBubble.call(this.parent,e,t))}},_fire:function(e,t){var i,r=this.eventListeners[e];if(t=t||{},t.currentTarget=this,t.type=e,r)for(i=0;i<r.length;i++)r[i].handler.call(this,t)},draw:function(){return this.drawScene(),this.drawHit(),this}}),e.Node.create=function(t,r){return e.Util._isString(t)&&(t=JSON.parse(t)),this._createNode(t,r)},e.Node._createNode=function(t,r){var s,a,o,i=e.Node.prototype.getClassName.call(t),n=t.children;if(r&&(t.attrs.container=r),s=new e[i](t.attrs),n)for(a=n.length,o=0;a>o;o++)s.add(this._createNode(n[o]));return s},e.Factory.addOverloadedGetterSetter(e.Node,"position"),e.Factory.addGetterSetter(e.Node,"x",0),e.Factory.addGetterSetter(e.Node,"y",0),e.Factory.addGetterSetter(e.Node,"globalCompositeOperation","source-over"),e.Factory.addGetterSetter(e.Node,"opacity",1),e.Factory.addGetter(e.Node,"name"),e.Factory.addOverloadedGetterSetter(e.Node,"name"),e.Factory.addGetter(e.Node,"id"),e.Factory.addOverloadedGetterSetter(e.Node,"id"),e.Factory.addGetterSetter(e.Node,"rotation",0),e.Factory.addComponentsGetterSetter(e.Node,"scale",["x","y"]),e.Factory.addGetterSetter(e.Node,"scaleX",1),e.Factory.addGetterSetter(e.Node,"scaleY",1),e.Factory.addComponentsGetterSetter(e.Node,"skew",["x","y"]),e.Factory.addGetterSetter(e.Node,"skewX",0),e.Factory.addGetterSetter(e.Node,"skewY",0),e.Factory.addComponentsGetterSetter(e.Node,"offset",["x","y"]),e.Factory.addGetterSetter(e.Node,"offsetX",0),e.Factory.addGetterSetter(e.Node,"offsetY",0),e.Factory.addSetter(e.Node,"dragDistance"),e.Factory.addOverloadedGetterSetter(e.Node,"dragDistance"),e.Factory.addSetter(e.Node,"width",0),e.Factory.addOverloadedGetterSetter(e.Node,"width"),e.Factory.addSetter(e.Node,"height",0),e.Factory.addOverloadedGetterSetter(e.Node,"height"),e.Factory.addGetterSetter(e.Node,"listening","inherit"),e.Factory.addGetterSetter(e.Node,"preventDefault",!0),e.Factory.addGetterSetter(e.Node,"filters",void 0,function(e){return this._filterUpToDate=!1,e}),e.Factory.addGetterSetter(e.Node,"visible","inherit"),e.Factory.addGetterSetter(e.Node,"transformsEnabled","all"),e.Factory.addOverloadedGetterSetter(e.Node,"size"),e.Factory.backCompat(e.Node,{rotateDeg:"rotate",setRotationDeg:"setRotation",getRotationDeg:"getRotation"}),e.Collection.mapMethods(e.Node)}(Konva);