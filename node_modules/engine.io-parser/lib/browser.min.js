function encodeBase64Object(e,t){var r="b"+exports.packets[e.type]+e.data.data;return t(r)}function encodeArrayBuffer(e,t,r){if(!t)return exports.encodeBase64Packet(e,r);var i=e.data,n=new Uint8Array(i),s=new Uint8Array(1+i.byteLength);s[0]=packets[e.type];for(var a=0;a<n.length;a++)s[a+1]=n[a];return r(s.buffer)}function encodeBlobAsArrayBuffer(e,t,r){if(!t)return exports.encodeBase64Packet(e,r);var i=new FileReader;return i.onload=function(){e.data=i.result,exports.encodePacket(e,t,!0,r)},i.readAsArrayBuffer(e.data)}function encodeBlob(e,t,r){if(!t)return exports.encodeBase64Packet(e,r);if(dontSendBlobs)return encodeBlobAsArrayBuffer(e,t,r);var i=new Uint8Array(1);i[0]=packets[e.type];var n=new Blob([i.buffer,e.data]);return r(n)}function tryDecode(e){try{e=utf8.decode(e)}catch(t){return!1}return e}function map(e,t,r){for(var i=new Array(e.length),n=after(e.length,r),s=function(e,r,n){t(r,function(t,r){i[e]=r,n(t,i)})},a=0;a<e.length;a++)s(a,e[a],n)}var keys=require("./keys"),hasBinary=require("has-binary"),sliceBuffer=require("arraybuffer.slice"),after=require("after"),utf8=require("wtf-8"),base64encoder;global&&global.ArrayBuffer&&(base64encoder=require("base64-arraybuffer"));var isAndroid="undefined"!=typeof navigator&&/Android/i.test(navigator.userAgent),isPhantomJS="undefined"!=typeof navigator&&/PhantomJS/i.test(navigator.userAgent),dontSendBlobs=isAndroid||isPhantomJS;exports.protocol=3;var packets=exports.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6},packetslist=keys(packets),err={type:"error",data:"parser error"},Blob=require("blob");exports.encodePacket=function(e,t,r,i){"function"==typeof t&&(i=t,t=!1),"function"==typeof r&&(i=r,r=null);var n=void 0===e.data?void 0:e.data.buffer||e.data;if(global.ArrayBuffer&&n instanceof ArrayBuffer)return encodeArrayBuffer(e,t,i);if(Blob&&n instanceof global.Blob)return encodeBlob(e,t,i);if(n&&n.base64)return encodeBase64Object(e,i);var s=packets[e.type];return void 0!==e.data&&(s+=r?utf8.encode(String(e.data)):String(e.data)),i(""+s)},exports.encodeBase64Packet=function(e,t){var r="b"+exports.packets[e.type];if(Blob&&e.data instanceof global.Blob){var i=new FileReader;return i.onload=function(){var e=i.result.split(",")[1];t(r+e)},i.readAsDataURL(e.data)}var n;try{n=String.fromCharCode.apply(null,new Uint8Array(e.data))}catch(s){for(var a=new Uint8Array(e.data),o=new Array(a.length),h=0;h<a.length;h++)o[h]=a[h];n=String.fromCharCode.apply(null,o)}return r+=global.btoa(n),t(r)},exports.decodePacket=function(e,t,r){if(void 0===e)return err;if("string"==typeof e){if("b"==e.charAt(0))return exports.decodeBase64Packet(e.substr(1),t);if(r&&(e=tryDecode(e),e===!1))return err;var i=e.charAt(0);return Number(i)==i&&packetslist[i]?e.length>1?{type:packetslist[i],data:e.substring(1)}:{type:packetslist[i]}:err}var n=new Uint8Array(e),i=n[0],s=sliceBuffer(e,1);return Blob&&"blob"===t&&(s=new Blob([s])),{type:packetslist[i],data:s}},exports.decodeBase64Packet=function(e,t){var r=packetslist[e.charAt(0)];if(!base64encoder)return{type:r,data:{base64:!0,data:e.substr(1)}};var i=base64encoder.decode(e.substr(1));return"blob"===t&&Blob&&(i=new Blob([i])),{type:r,data:i}},exports.encodePayload=function(e,t,r){function n(e){return e.length+":"+e}function s(e,r){exports.encodePacket(e,i?t:!1,!0,function(e){r(null,n(e))})}"function"==typeof t&&(r=t,t=null);var i=hasBinary(e);return t&&i?Blob&&!dontSendBlobs?exports.encodePayloadAsBlob(e,r):exports.encodePayloadAsArrayBuffer(e,r):e.length?void map(e,s,function(e,t){return r(t.join(""))}):r("0:")},exports.decodePayload=function(e,t,r){if("string"!=typeof e)return exports.decodePayloadAsBinary(e,t,r);"function"==typeof t&&(r=t,t=null);var i;if(""==e)return r(err,0,1);for(var s,a,n="",o=0,h=e.length;h>o;o++){var u=e.charAt(o);if(":"!=u)n+=u;else{if(""==n||n!=(s=Number(n)))return r(err,0,1);if(a=e.substr(o+1,s),n!=a.length)return r(err,0,1);if(a.length){if(i=exports.decodePacket(a,t,!0),err.type==i.type&&err.data==i.data)return r(err,0,1);var c=r(i,o+s,h);if(!1===c)return}o+=s,n=""}}return""!=n?r(err,0,1):void 0},exports.encodePayloadAsArrayBuffer=function(e,t){function r(e,t){exports.encodePacket(e,!0,!0,function(e){return t(null,e)})}return e.length?void map(e,r,function(e,r){var i=r.reduce(function(e,t){var r;return r="string"==typeof t?t.length:t.byteLength,e+r.toString().length+r+2},0),n=new Uint8Array(i),s=0;return r.forEach(function(e){var t="string"==typeof e,r=e;if(t){for(var i=new Uint8Array(e.length),a=0;a<e.length;a++)i[a]=e.charCodeAt(a);r=i.buffer}t?n[s++]=0:n[s++]=1;for(var o=r.byteLength.toString(),a=0;a<o.length;a++)n[s++]=parseInt(o[a]);n[s++]=255;for(var i=new Uint8Array(r),a=0;a<i.length;a++)n[s++]=i[a]}),t(n.buffer)}):t(new ArrayBuffer(0))},exports.encodePayloadAsBlob=function(e,t){function r(e,t){exports.encodePacket(e,!0,!0,function(e){var r=new Uint8Array(1);if(r[0]=1,"string"==typeof e){for(var i=new Uint8Array(e.length),n=0;n<e.length;n++)i[n]=e.charCodeAt(n);e=i.buffer,r[0]=0}for(var s=e instanceof ArrayBuffer?e.byteLength:e.size,a=s.toString(),o=new Uint8Array(a.length+1),n=0;n<a.length;n++)o[n]=parseInt(a[n]);if(o[a.length]=255,Blob){var h=new Blob([r.buffer,o.buffer,e]);t(null,h)}})}map(e,r,function(e,r){return t(new Blob(r))})},exports.decodePayloadAsBinary=function(e,t,r){"function"==typeof t&&(r=t,t=null);for(var i=e,n=[],s=!1;i.byteLength>0;){for(var a=new Uint8Array(i),o=0===a[0],h="",u=1;255!=a[u];u++){if(h.length>310){s=!0;break}h+=a[u]}if(s)return r(err,0,1);i=sliceBuffer(i,2+h.length),h=parseInt(h);var c=sliceBuffer(i,0,h);if(o)try{c=String.fromCharCode.apply(null,new Uint8Array(c))}catch(l){var f=new Uint8Array(c);c="";for(var u=0;u<f.length;u++)c+=String.fromCharCode(f[u])}n.push(c),i=sliceBuffer(i,h)}var p=n.length;n.forEach(function(e,i){r(exports.decodePacket(e,t,!0),i,p)})};