"use strict";function isConstant(e){return constantinople(e,{jade:runtime,jade_interp:void 0})}function toConstant(e){return constantinople.toConstant(e,{jade:runtime,jade_interp:void 0})}function errorAtNode(e,t){return t.line=e.line,t.filename=e.filename,t}var nodes=require("./nodes"),filters=require("./filters"),doctypes=require("./doctypes"),runtime=require("./runtime"),utils=require("./utils"),selfClosing=require("void-elements"),parseJSExpression=require("character-parser").parseMax,constantinople=require("constantinople"),Compiler=module.exports=function(e,t){this.options=t=t||{},this.node=e,this.hasCompiledDoctype=!1,this.hasCompiledTag=!1,this.pp=t.pretty||!1,this.pp&&"string"!=typeof this.pp&&(this.pp="  "),this.debug=!1!==t.compileDebug,this.indents=0,this.parentIndents=0,this.terse=!1,this.mixins={},this.dynamicMixins=!1,t.doctype&&this.setDoctype(t.doctype)};Compiler.prototype={compile:function(){if(this.buf=[],this.pp&&this.buf.push("var jade_indent = [];"),this.lastBufferedIdx=-1,this.visit(this.node),!this.dynamicMixins)for(var e=Object.keys(this.mixins),t=0;t<e.length;t++){var r=this.mixins[e[t]];if(!r.used)for(var i=0;i<r.instances.length;i++)for(var n=r.instances[i].start;n<r.instances[i].end;n++)this.buf[n]=""}return this.buf.join("\n")},setDoctype:function(e){this.doctype=doctypes[e.toLowerCase()]||"<!DOCTYPE "+e+">",this.terse="<!doctype html>"==this.doctype.toLowerCase(),this.xml=0==this.doctype.indexOf("<?xml")},buffer:function(e,t){if(t){var i=/(\\)?([#!]){((?:.|\n)*)$/.exec(e);if(i){if(this.buffer(e.substr(0,i.index),!1),i[1])return this.buffer(i[2]+"{",!1),void this.buffer(i[3],!0);var n=i[3],s=parseJSExpression(n),a=("!"==i[2]?"":"jade.escape")+"((jade_interp = "+s.src+") == null ? '' : jade_interp)";return this.bufferExpression(a),void this.buffer(n.substr(s.end+1),!0)}}e=utils.stringify(e),e=e.substr(1,e.length-2),this.lastBufferedIdx==this.buf.length?("code"===this.lastBufferedType&&(this.lastBuffered+=' + "'),this.lastBufferedType="text",this.lastBuffered+=e,this.buf[this.lastBufferedIdx-1]="buf.push("+this.bufferStartChar+this.lastBuffered+'");'):(this.buf.push('buf.push("'+e+'");'),this.lastBufferedType="text",this.bufferStartChar='"',this.lastBuffered=e,this.lastBufferedIdx=this.buf.length)},bufferExpression:function(e){return isConstant(e)?this.buffer(toConstant(e)+"",!1):void(this.lastBufferedIdx==this.buf.length?("text"===this.lastBufferedType&&(this.lastBuffered+='"'),this.lastBufferedType="code",this.lastBuffered+=" + ("+e+")",this.buf[this.lastBufferedIdx-1]="buf.push("+this.bufferStartChar+this.lastBuffered+");"):(this.buf.push("buf.push("+e+");"),this.lastBufferedType="code",this.bufferStartChar="",this.lastBuffered="("+e+")",this.lastBufferedIdx=this.buf.length))},prettyIndent:function(e,t){e=e||0,t=t?"\n":"",this.buffer(t+Array(this.indents+e).join(this.pp)),this.parentIndents&&this.buf.push("buf.push.apply(buf, jade_indent);")},visit:function(e){var t=this.debug;t&&this.buf.push("jade_debug.unshift(new jade.DebugItem( "+e.line+", "+(e.filename?utils.stringify(e.filename):"jade_debug[0].filename")+" ));"),!1===e.debug&&this.debug&&(this.buf.pop(),this.buf.pop()),this.visitNode(e),t&&this.buf.push("jade_debug.shift();")},visitNode:function(e){return this["visit"+e.type](e)},visitCase:function(e){var t=this.withinCase;this.withinCase=!0,this.buf.push("switch ("+e.expr+"){"),this.visit(e.block),this.buf.push("}"),this.withinCase=t},visitWhen:function(e){"default"==e.expr?this.buf.push("default:"):this.buf.push("case "+e.expr+":"),e.block&&(this.visit(e.block),this.buf.push("  break;"))},visitLiteral:function(e){this.buffer(e.str)},visitBlock:function(e){var t=e.nodes.length,r=this.escape,i=this.pp;i&&t>1&&!r&&e.nodes[0].isText&&e.nodes[1].isText&&this.prettyIndent(1,!0);for(var n=0;t>n;++n)i&&n>0&&!r&&e.nodes[n].isText&&e.nodes[n-1].isText&&this.prettyIndent(1,!1),this.visit(e.nodes[n]),e.nodes[n+1]&&e.nodes[n].isText&&e.nodes[n+1].isText&&this.buffer("\n")},visitMixinBlock:function(e){this.pp&&this.buf.push("jade_indent.push('"+Array(this.indents+1).join(this.pp)+"');"),this.buf.push("block && block();"),this.pp&&this.buf.push("jade_indent.pop();")},visitDoctype:function(e){!e||!e.val&&this.doctype||this.setDoctype(e.val||"default"),this.doctype&&this.buffer(this.doctype),this.hasCompiledDoctype=!0},visitMixin:function(e){var t="jade_mixins[",r=e.args||"",i=e.block,n=e.attrs,s=e.attributeBlocks.slice(),a=this.pp,o="#"===e.name[0],u=e.name;if(o&&(this.dynamicMixins=!0),t+=(o?e.name.substr(2,e.name.length-3):'"'+e.name+'"')+"]",this.mixins[u]=this.mixins[u]||{used:!1,instances:[]},e.call){if(this.mixins[u].used=!0,a&&this.buf.push("jade_indent.push('"+Array(this.indents+1).join(a)+"');"),i||n.length||s.length){if(this.buf.push(t+".call({"),i){this.buf.push("block: function(){"),this.parentIndents++;var c=this.indents;this.indents=0,this.visit(e.block),this.indents=c,this.parentIndents--,n.length||s.length?this.buf.push("},"):this.buf.push("}")}if(s.length){if(n.length){var h=this.attrs(n);s.unshift(h)}this.buf.push("attributes: jade.merge(["+s.join(",")+"])")}else if(n.length){var h=this.attrs(n);this.buf.push("attributes: "+h)}r?this.buf.push("}, "+r+");"):this.buf.push("});")}else this.buf.push(t+"("+r+");");a&&this.buf.push("jade_indent.pop();")}else{var l=this.buf.length;r=r?r.split(","):[];var f;r.length&&/^\.\.\./.test(r[r.length-1].trim())&&(f=r.pop().trim().replace(/^\.\.\./,"")),this.buf.push(t+" = jade_interp = function("+r.join(",")+"){"),this.buf.push("var block = (this && this.block), attributes = (this && this.attributes) || {};"),f&&(this.buf.push("var "+f+" = [];"),this.buf.push("for (jade_interp = "+r.length+"; jade_interp < arguments.length; jade_interp++) {"),this.buf.push("  "+f+".push(arguments[jade_interp]);"),this.buf.push("}")),this.parentIndents++,this.visit(i),this.parentIndents--,this.buf.push("};");var p=this.buf.length;this.mixins[u].instances.push({start:l,end:p})}},visitTag:function(e){function n(){e.buffer?i.bufferExpression(t):i.buffer(t)}this.indents++;var t=e.name,r=this.pp,i=this;if("pre"==e.name&&(this.escape=!0),this.hasCompiledTag||(this.hasCompiledDoctype||"html"!=t||this.visitDoctype(),this.hasCompiledTag=!0),r&&!e.isInline()&&this.prettyIndent(0,!0),e.selfClosing||!this.xml&&selfClosing[e.name]){if(this.buffer("<"),n(),this.visitAttributes(e.attrs,e.attributeBlocks.slice()),this.terse?this.buffer(">"):this.buffer("/>"),e.block&&("Block"!==e.block.type||0!==e.block.nodes.length)&&e.block.nodes.some(function(e){return"Text"!==e.type||!/^\s*$/.test(e.val)}))throw errorAtNode(e,new Error(t+" is self closing and should not have content."))}else this.buffer("<"),n(),this.visitAttributes(e.attrs,e.attributeBlocks.slice()),this.buffer(">"),e.code&&this.visitCode(e.code),this.visit(e.block),!r||e.isInline()||"pre"==e.name||e.canInline()||this.prettyIndent(0,!0),this.buffer("</"),n(),this.buffer(">");"pre"==e.name&&(this.escape=!1),this.indents--},visitFilter:function(e){var t=e.block.nodes.map(function(e){return e.val}).join("\n");e.attrs.filename=this.options.filename;try{this.buffer(filters(e.name,t,e.attrs),!0)}catch(r){throw errorAtNode(e,r)}},visitText:function(e){this.buffer(e.val,!0)},visitComment:function(e){e.buffer&&(this.pp&&this.prettyIndent(1,!0),this.buffer("<!--"+e.val+"-->"))},visitBlockComment:function(e){e.buffer&&(this.pp&&this.prettyIndent(1,!0),this.buffer("<!--"+e.val),this.visit(e.block),this.pp&&this.prettyIndent(1,!0),this.buffer("-->"))},visitCode:function(e){if(e.buffer){var t=e.val.trim();t="null == (jade_interp = "+t+') ? "" : jade_interp',e.escape&&(t="jade.escape("+t+")"),this.bufferExpression(t)}else this.buf.push(e.val);e.block&&(e.buffer||this.buf.push("{"),this.visit(e.block),e.buffer||this.buf.push("}"))},visitEach:function(e){this.buf.push("// iterate "+e.obj+"\n;(function(){\n  var $$obj = "+e.obj+";\n  if ('number' == typeof $$obj.length) {\n"),e.alternative&&this.buf.push("  if ($$obj.length) {"),this.buf.push("    for (var "+e.key+" = 0, $$l = $$obj.length; "+e.key+" < $$l; "+e.key+"++) {\n      var "+e.val+" = $$obj["+e.key+"];\n"),this.visit(e.block),this.buf.push("    }\n"),e.alternative&&(this.buf.push("  } else {"),this.visit(e.alternative),this.buf.push("  }")),this.buf.push("  } else {\n    var $$l = 0;\n    for (var "+e.key+" in $$obj) {\n      $$l++;      var "+e.val+" = $$obj["+e.key+"];\n"),this.visit(e.block),this.buf.push("    }\n"),e.alternative&&(this.buf.push("    if ($$l === 0) {"),this.visit(e.alternative),this.buf.push("    }")),this.buf.push("  }\n}).call(this);\n")},visitAttributes:function(e,t){if(t.length){if(e.length){var r=this.attrs(e);t.unshift(r)}this.bufferExpression("jade.attrs(jade.merge(["+t.join(",")+"]), "+utils.stringify(this.terse)+")")}else e.length&&this.attrs(e,!0)},attrs:function(e,t){var r=[],i=[],n=[];return e.forEach(function(e){var s=e.name,a=e.escaped;if("class"===s)i.push(e.val),n.push(e.escaped);else if(isConstant(e.val))if(t)this.buffer(runtime.attr(s,toConstant(e.val),a,this.terse));else{var o=toConstant(e.val);"style"===s&&(o=runtime.style(o)),!a||0===s.indexOf("data")&&"string"!=typeof o||(o=runtime.escape(o)),r.push(utils.stringify(s)+": "+utils.stringify(o))}else if(t)this.bufferExpression('jade.attr("'+s+'", '+e.val+", "+utils.stringify(a)+", "+utils.stringify(this.terse)+")");else{var o=e.val;"style"===s&&(o="jade.style("+o+")"),a&&0!==s.indexOf("data")?o="jade.escape("+o+")":a&&(o="(typeof (jade_interp = "+o+') == "string" ? jade.escape(jade_interp) : jade_interp)'),r.push(utils.stringify(s)+": "+o)}}.bind(this)),t?i.every(isConstant)?this.buffer(runtime.cls(i.map(toConstant),n)):this.bufferExpression("jade.cls(["+i.join(",")+"], "+utils.stringify(n)+")"):i.length&&(i=i.every(isConstant)?utils.stringify(runtime.joinClasses(i.map(toConstant).map(runtime.joinClasses).map(function(e,t){return n[t]?runtime.escape(e):e}))):"(jade_interp = "+utils.stringify(n)+", jade.joinClasses(["+i.join(",")+"].map(jade.joinClasses).map(function (cls, i) {   return jade_interp[i] ? jade.escape(cls) : cls })))",i.length&&r.push('"class": '+i)),"{"+r.join(",")+"}"}};