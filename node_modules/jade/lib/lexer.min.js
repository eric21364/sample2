"use strict";function assertExpression(e){Function("","return ("+e+")")}function assertNestingCorrect(e){var t=characterParser(e);if(t.isNesting())throw new Error("Nesting must match on expression `"+e+"`")}var utils=require("./utils"),characterParser=require("character-parser"),Lexer=module.exports=function(e,t){this.input=e.replace(/\r\n|\r/g,"\n"),this.filename=t,this.deferredTokens=[],this.lastIndents=0,this.lineno=1,this.stash=[],this.indentStack=[],this.indentRe=null,this.pipeless=!1};Lexer.prototype={tok:function(e,t){return{type:e,line:this.lineno,val:t}},consume:function(e){this.input=this.input.substr(e)},scan:function(e,t){var r;return(r=e.exec(this.input))?(this.consume(r[0].length),this.tok(t,r[1])):void 0},defer:function(e){this.deferredTokens.push(e)},lookahead:function(e){for(var t=e-this.stash.length;t-->0;)this.stash.push(this.next());return this.stash[--e]},bracketExpression:function(e){e=e||0;var t=this.input[e];if("("!=t&&"{"!=t&&"["!=t)throw new Error("unrecognized start character");var r={"(":")","{":"}","[":"]"}[t],i=characterParser.parseMax(this.input,{start:e+1});if(this.input[i.end]!==r)throw new Error("start character "+t+" does not match end character "+this.input[i.end]);return i},stashed:function(){return this.stash.length&&this.stash.shift()},deferred:function(){return this.deferredTokens.length&&this.deferredTokens.shift()},eos:function(){return this.input.length?void 0:this.indentStack.length?(this.indentStack.shift(),this.tok("outdent")):this.tok("eos")},blank:function(){var e;return(e=/^\n *\n/.exec(this.input))?(this.consume(e[0].length-1),++this.lineno,this.pipeless?this.tok("text",""):this.next()):void 0},comment:function(){var e;if(e=/^\/\/(-)?([^\n]*)/.exec(this.input)){this.consume(e[0].length);var t=this.tok("comment",e[2]);return t.buffer="-"!=e[1],this.pipeless=!0,t}},interpolation:function(){if(/^#\{/.test(this.input)){var e=this.bracketExpression(1);return this.consume(e.end+1),this.tok("interpolation",e.src)}},tag:function(){var e;if(e=/^(\w[-:\w]*)(\/?)/.exec(this.input)){this.consume(e[0].length);var t,r=e[1];if(":"==r[r.length-1])for(r=r.slice(0,-1),t=this.tok("tag",r),this.defer(this.tok(":"))," "!==this.input[0]&&console.warn("Warning: space required after `:` on line "+this.lineno+' of jade file "'+this.filename+'"');" "==this.input[0];)this.input=this.input.substr(1);else t=this.tok("tag",r);return t.selfClosing=!!e[2],t}},filter:function(){var e=this.scan(/^:([\w\-]+)/,"filter");return e?(this.pipeless=!0,e):void 0},doctype:function(){if(this.scan(/^!!! *([^\n]+)?/,"doctype"))throw new Error("`!!!` is deprecated, you must now use `doctype`");var e=this.scan(/^(?:doctype) *([^\n]+)?/,"doctype");if(e&&e.val&&"5"===e.val.trim())throw new Error("`doctype 5` is deprecated, you must now use `doctype html`");return e},id:function(){return this.scan(/^#([\w-]+)/,"id")},className:function(){return this.scan(/^\.([\w-]+)/,"class")},text:function(){return this.scan(/^(?:\| ?| )([^\n]+)/,"text")||this.scan(/^\|?( )/,"text")||this.scan(/^(<[^\n]*)/,"text")},textFail:function(){var e;return(e=this.scan(/^([^\.\n][^\n]+)/,"text"))?(console.warn("Warning: missing space before text for line "+this.lineno+' of jade file "'+this.filename+'"'),e):void 0},dot:function(){var e;return(e=this.scan(/^\./,"dot"))?(this.pipeless=!0,e):void 0},"extends":function(){return this.scan(/^extends? +([^\n]+)/,"extends")},prepend:function(){var e;if(e=/^prepend +([^\n]+)/.exec(this.input)){this.consume(e[0].length);var t="prepend",r=e[1],i=this.tok("block",r);return i.mode=t,i}},append:function(){var e;if(e=/^append +([^\n]+)/.exec(this.input)){this.consume(e[0].length);var t="append",r=e[1],i=this.tok("block",r);return i.mode=t,i}},block:function(){var e;if(e=/^block\b *(?:(prepend|append) +)?([^\n]+)/.exec(this.input)){this.consume(e[0].length);var t=e[1]||"replace",r=e[2],i=this.tok("block",r);return i.mode=t,i}},mixinBlock:function(){var e;return(e=/^block[ \t]*(\n|$)/.exec(this.input))?(this.consume(e[0].length-e[1].length),this.tok("mixin-block")):void 0},"yield":function(){return this.scan(/^yield */,"yield")},include:function(){return this.scan(/^include +([^\n]+)/,"include")},includeFiltered:function(){var e;if(e=/^include:([\w\-]+)([\( ])/.exec(this.input)){this.consume(e[0].length-1);var t=e[1],r="("===e[2]?this.attrs():null;if(" "!==e[2]&&" "!==this.input[0])throw new Error("expected space after include:filter but got "+utils.stringify(this.input[0]));if(e=/^ *([^\n]+)/.exec(this.input),!e||""===e[1].trim())throw new Error("missing path for include:filter");this.consume(e[0].length);var i=e[1],n=this.tok("include",i);return n.filter=t,n.attrs=r,n}},"case":function(){return this.scan(/^case +([^\n]+)/,"case")},when:function(){return this.scan(/^when +([^:\n]+)/,"when")},"default":function(){return this.scan(/^default */,"default")},call:function(){var e,t;if(t=/^\+(\s*)(([-\w]+)|(#\{))/.exec(this.input)){if(t[3])this.consume(t[0].length),e=this.tok("call",t[3]);else{var r=this.bracketExpression(2+t[1].length);this.consume(r.end+1),assertExpression(r.src),e=this.tok("call","#{"+r.src+"}")}if(t=/^ *\(/.exec(this.input)){var i=this.bracketExpression(t[0].length-1);/^\s*[-\w]+ *=/.test(i.src)||(this.consume(i.end+1),e.args=i.src),e.args&&assertExpression("["+e.args+"]")}return e}},mixin:function(){var e;if(e=/^mixin +([-\w]+)(?: *\((.*)\))? */.exec(this.input)){this.consume(e[0].length);var t=this.tok("mixin",e[1]);return t.args=e[2],t}},conditional:function(){var e;if(e=/^(if|unless|else if|else)\b([^\n]*)/.exec(this.input)){this.consume(e[0].length);var t=e[1],r=e[2],i=!1,n=!1;switch(t){case"if":assertExpression(r),r="if ("+r+")",i=!0;break;case"unless":assertExpression(r),r="if (!("+r+"))",i=!0;break;case"else if":assertExpression(r),r="else if ("+r+")",i=!0,n=!0;break;case"else":if(r&&r.trim())throw new Error("`else` cannot have a condition, perhaps you meant `else if`");r="else",n=!0}var s=this.tok("code",r);return s.isElse=n,s.isIf=i,s.requiresBlock=!0,s}},"while":function(){var e;if(e=/^while +([^\n]+)/.exec(this.input)){this.consume(e[0].length),assertExpression(e[1]);var t=this.tok("code","while ("+e[1]+")");return t.requiresBlock=!0,t}},each:function(){var e;if(e=/^(?:- *)?(?:each|for) +([a-zA-Z_$][\w$]*)(?: *, *([a-zA-Z_$][\w$]*))? * in *([^\n]+)/.exec(this.input)){this.consume(e[0].length);var t=this.tok("each",e[1]);return t.key=e[2]||"$index",assertExpression(e[3]),t.code=e[3],t}},code:function(){var e;if(e=/^(!?=|-)[ \t]*([^\n]+)/.exec(this.input)){this.consume(e[0].length);var t=e[1];e[1]=e[2];var r=this.tok("code",e[1]);return r.escape="="===t.charAt(0),r.buffer="="===t.charAt(0)||"="===t.charAt(1),r.buffer&&assertExpression(e[1]),r}},blockCode:function(){var e;if(e=/^-\n/.exec(this.input)){this.consume(e[0].length-1);var t=this.tok("blockCode");return this.pipeless=!0,t}},attrs:function(){if("("==this.input.charAt(0)){var e=this.bracketExpression().end,t=this.input.substr(1,e-1),r=this.tok("attrs");assertNestingCorrect(t);var i="",n=function(e){return e.replace(/(\\)?#\{(.+)/g,function(e,t,r){if(t)return e;try{var s=characterParser.parseMax(r);return"}"!==r[s.end]?e.substr(0,2)+n(e.substr(2)):(assertExpression(s.src),i+" + ("+s.src+") + "+i+n(r.substr(s.end+1)))}catch(a){return e.substr(0,2)+n(e.substr(2))}})};this.consume(e+1),r.attrs=[];var s=!0,a="",o="",u="",c=characterParser.defaultState(),h="key",l=function(e){if(""===a.trim())return!1;if(e===t.length)return!0;if("key"===h){if(" "===t[e]||"\n"===t[e])for(var r=e;r<t.length;r++)if(" "!=t[r]&&"\n"!=t[r])return"="===t[r]||"!"===t[r]||","===t[r]?!1:!0;return","===t[e]}if("value"===h&&!c.isNesting())try{if(assertExpression(o)," "===t[e]||"\n"===t[e])for(var r=e;r<t.length;r++)if(" "!=t[r]&&"\n"!=t[r])return characterParser.isPunctuator(t[r])&&'"'!=t[r]&&"'"!=t[r]?!1:!0;return","===t[e]}catch(i){return!1}};this.lineno+=t.split("\n").length-1;for(var f=0;f<=t.length;f++)if(l(f))o=o.trim(),o&&assertExpression(o),a=a.trim(),a=a.replace(/^['"]|['"]$/g,""),r.attrs.push({name:a,val:""==o?!0:o,escaped:s}),a=o="",h="key",s=!1;else switch(h){case"key-char":if(t[f]===i){if(h="key",f+1<t.length&&-1===[" ",",","!","=","\n"].indexOf(t[f+1]))throw new Error("Unexpected character "+t[f+1]+" expected ` `, `\\n`, `,`, `!` or `=`")}else a+=t[f];break;case"key":if(""!==a||'"'!==t[f]&&"'"!==t[f])if("!"===t[f]||"="===t[f]){if(s="!"!==t[f],"!"===t[f]&&f++,"="!==t[f])throw new Error("Unexpected character "+t[f]+" expected `=`");h="value",c=characterParser.defaultState()}else a+=t[f];else h="key-char",i=t[f];break;case"value":c=characterParser.parseChar(t[f],c),c.isString()?(h="string",i=t[f],u=t[f]):o+=t[f];break;case"string":c=characterParser.parseChar(t[f],c),u+=t[f],c.isString()||(h="value",o+=n(u))}return"/"==this.input.charAt(0)&&(this.consume(1),r.selfClosing=!0),r}},attributesBlock:function(){if(/^&attributes\b/.test(this.input)){this.consume(11);var t=this.bracketExpression();return this.consume(t.end+1),this.tok("&attributes",t.src)}},indent:function(){var e,t;if(this.indentRe?e=this.indentRe.exec(this.input):(t=/^\n(\t*) */,e=t.exec(this.input),e&&!e[1].length&&(t=/^\n( *)/,e=t.exec(this.input)),e&&e[1].length&&(this.indentRe=t)),e){var r,i=e[1].length;if(++this.lineno,this.consume(i+1)," "==this.input[0]||"	"==this.input[0])throw new Error("Invalid indentation, you can use tabs or spaces but not both");if("\n"==this.input[0])return this.pipeless=!1,this.tok("newline");if(this.indentStack.length&&i<this.indentStack[0]){for(;this.indentStack.length&&this.indentStack[0]>i;)this.stash.push(this.tok("outdent")),this.indentStack.shift();r=this.stash.pop()}else i&&i!=this.indentStack[0]?(this.indentStack.unshift(i),r=this.tok("indent",i)):r=this.tok("newline");return this.pipeless=!1,r}},pipelessText:function(){if(this.pipeless){var e,t;this.indentRe?e=this.indentRe.exec(this.input):(t=/^\n(\t*) */,e=t.exec(this.input),e&&!e[1].length&&(t=/^\n( *)/,e=t.exec(this.input)),e&&e[1].length&&(this.indentRe=t));var r=e&&e[1].length;if(r&&(0===this.indentStack.length||r>this.indentStack[0])){var a,i=e[1],s=[];do{var o=this.input.substr(1).indexOf("\n");-1==o&&(o=this.input.length-1);var u=this.input.substr(1,o);a=u.substr(0,i.length)===i||!u.trim(),a&&(this.consume(u.length+1),++this.lineno,s.push(u.substr(i.length)))}while(this.input.length&&a);for(;0===this.input.length&&""===s[s.length-1];)s.pop();return this.tok("pipeless-text",s)}}},colon:function(){var e=/^: +/.test(this.input),t=this.scan(/^: */,":");return t&&!e&&console.warn("Warning: space required after `:` on line "+this.lineno+' of jade file "'+this.filename+'"'),t},fail:function(){throw new Error("unexpected text "+this.input.substr(0,5))},advance:function(){return this.stashed()||this.next()},next:function(){return this.deferred()||this.blank()||this.eos()||this.pipelessText()||this["yield"]()||this.doctype()||this.interpolation()||this["case"]()||this.when()||this["default"]()||this["extends"]()||this.append()||this.prepend()||this.block()||this.mixinBlock()||this.include()||this.includeFiltered()||this.mixin()||this.call()||this.conditional()||this.each()||this["while"]()||this.tag()||this.filter()||this.blockCode()||this.code()||this.id()||this.className()||this.attrs()||this.attributesBlock()||this.indent()||this.text()||this.comment()||this.colon()||this.dot()||this.textFail()||this.fail()}};