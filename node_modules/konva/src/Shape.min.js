!function(e){"use strict";function i(e){e.fill()}function n(e){e.stroke()}function s(e){e.fill()}function a(e){e.stroke()}function o(){this._clearCache(t)}function h(){this._clearCache(r)}var t="hasShadow",r="shadowRGBA";e.Shape=function(e){this.__init(e)},e.Util.addMethods(e.Shape,{__init:function(t){this.nodeType="Shape",this._fillFunc=i,this._strokeFunc=n,this._fillFuncHit=s,this._strokeFuncHit=a;for(var c,r=e.shapes;;)if(c=e.Util.getRandomColor(),c&&!(c in r))break;this.colorKey=c,r[c]=this,e.Node.call(this,t),this.on("shadowColorChange.konva shadowBlurChange.konva shadowOffsetChange.konva shadowOpacityChange.konva shadowEnabledChange.konva",o),this.on("shadowColorChange.konva shadowOpacityChange.konva shadowEnabledChange.konva",h)},hasChildren:function(){return!1},getChildren:function(){return[]},getContext:function(){return this.getLayer().getContext()},getCanvas:function(){return this.getLayer().getCanvas()},hasShadow:function(){return this._getCache(t,this._hasShadow)},_hasShadow:function(){return this.getShadowEnabled()&&0!==this.getShadowOpacity()&&!!(this.getShadowColor()||this.getShadowBlur()||this.getShadowOffsetX()||this.getShadowOffsetY())},getShadowRGBA:function(){return this._getCache(r,this._getShadowRGBA)},_getShadowRGBA:function(){if(this.hasShadow()){var t=e.Util.colorToRGBA(this.shadowColor());return"rgba("+t.r+","+t.g+","+t.b+","+t.a*(this.getShadowOpacity()||1)+")"}},hasFill:function(){return!!(this.getFill()||this.getFillPatternImage()||this.getFillLinearGradientColorStops()||this.getFillRadialGradientColorStops())},hasStroke:function(){return this.strokeEnabled()&&!!this.stroke()},intersects:function(e){var i,t=this.getStage(),r=t.bufferHitCanvas;return r.getContext().clear(),this.drawHit(r),i=r.context.getImageData(Math.round(e.x),Math.round(e.y),1,1).data,i[3]>0},destroy:function(){return e.Node.prototype.destroy.call(this),delete e.shapes[this.colorKey],this},_useBufferCanvas:function(e){return!e&&this.perfectDrawEnabled()&&1!==this.getAbsoluteOpacity()&&this.hasFill()&&this.hasStroke()&&this.getStage()||this.perfectDrawEnabled()&&this.hasShadow()&&1!==this.getAbsoluteOpacity()&&this.hasFill()&&this.hasStroke()&&this.getStage()},getSelfRect:function(){var e=this.getSize();return{x:this._centroid?Math.round(-e.width/2):0,y:this._centroid?Math.round(-e.height/2):0,width:e.width,height:e.height}},getClientRect:function(e){var t=this.getSelfRect(),r=this.hasStroke()&&this.strokeWidth()||0,i=t.width+r,n=t.height+r,s=this.hasShadow()?this.shadowOffsetX():0,a=this.hasShadow()?this.shadowOffsetY():0,o=i+Math.abs(s),h=n+Math.abs(a),c=this.hasShadow()&&this.shadowBlur()||0,u=o+2*c,l=h+2*c,f=0;Math.round(r/2)!==r/2&&(f=1);var p={width:u+f,height:l+f,x:-Math.round(r/2+c)+Math.min(s,0)+t.x,y:-Math.round(r/2+c)+Math.min(a,0)+t.y};return e?p:this._transformedRect(p)},drawScene:function(e,t,r,i){var l,f,p,n=this.getLayer(),s=e||n.getCanvas(),a=s.getContext(),o=this._cache.canvas,h=this.sceneFunc(),c=this.hasShadow(),u=this.hasStroke();if(!this.isVisible())return this;if(o)return a.save(),n._applyTransform(this,a,t),this._drawCachedSceneCanvas(a),a.restore(),this;if(!h)return this;if(a.save(),this._useBufferCanvas(r)&&!i){if(l=this.getStage(),f=l.bufferCanvas,p=f.getContext(),p.clear(),p.save(),p._applyLineJoin(this),!r)if(n)n._applyTransform(this,p,t);else{var d=this.getAbsoluteTransform(t).getMatrix();a.transform(d[0],d[1],d[2],d[3],d[4],d[5])}h.call(this,p),p.restore();var v=f.pixelRatio;c&&!s.hitCanvas?(a.save(),a._applyShadow(this),a._applyOpacity(this),a._applyGlobalCompositeOperation(this),a.drawImage(f._canvas,0,0,f.width/v,f.height/v),a.restore()):(a._applyOpacity(this),a._applyGlobalCompositeOperation(this),a.drawImage(f._canvas,0,0,f.width/v,f.height/v))}else{if(a._applyLineJoin(this),!r)if(n)n._applyTransform(this,a,t);else{var g=this.getAbsoluteTransform(t).getMatrix();a.transform(g[0],g[1],g[2],g[3],g[4],g[5])}c&&u&&!s.hitCanvas?(a.save(),r||(a._applyOpacity(this),a._applyGlobalCompositeOperation(this)),a._applyShadow(this),h.call(this,a),a.restore(),this.hasFill()&&this.getShadowForStrokeEnabled()&&h.call(this,a)):c&&!s.hitCanvas?(a.save(),r||(a._applyOpacity(this),a._applyGlobalCompositeOperation(this)),a._applyShadow(this),h.call(this,a),a.restore()):(r||(a._applyOpacity(this),a._applyGlobalCompositeOperation(this)),h.call(this,a))}return a.restore(),this},drawHit:function(e,t,r){var i=this.getLayer(),n=e||i.hitCanvas,s=n.getContext(),a=this.hitFunc()||this.sceneFunc(),o=this._cache.canvas,h=o&&o.hit;if(!this.shouldDrawHit(n))return this;if(i&&i.clearHitCache(),h)return s.save(),i._applyTransform(this,s,t),this._drawCachedHitCanvas(s),s.restore(),this;if(!a)return this;if(s.save(),s._applyLineJoin(this),!r)if(i)i._applyTransform(this,s,t);else{var c=this.getAbsoluteTransform(t).getMatrix();s.transform(c[0],c[1],c[2],c[3],c[4],c[5])}return a.call(this,s),s.restore(),this},drawHitFromCache:function(t){var c,u,l,f,p,d,r=t||0,i=this._cache.canvas,n=this._getCachedSceneCanvas(),s=i.hit,a=s.getContext(),o=s.getWidth(),h=s.getHeight();a.clear(),a.drawImage(n._canvas,0,0,o,h);try{for(c=a.getImageData(0,0,o,h),u=c.data,l=u.length,f=e.Util._hexToRgb(this.colorKey),p=0;l>p;p+=4)d=u[p+3],d>r?(u[p]=f.r,u[p+1]=f.g,u[p+2]=f.b,u[p+3]=255):u[p+3]=0;a.putImageData(c,0,0)}catch(v){e.Util.error("Unable to draw hit graph from cached scene canvas. "+v.message)}return this}}),e.Util.extend(e.Shape,e.Node),e.Factory.addGetterSetter(e.Shape,"stroke"),e.Factory.addDeprecatedGetterSetter(e.Shape,"strokeRed",0,e.Validators.RGBComponent),e.Factory.addDeprecatedGetterSetter(e.Shape,"strokeGreen",0,e.Validators.RGBComponent),e.Factory.addDeprecatedGetterSetter(e.Shape,"strokeBlue",0,e.Validators.RGBComponent),e.Factory.addDeprecatedGetterSetter(e.Shape,"strokeAlpha",1,e.Validators.alphaComponent),e.Factory.addGetterSetter(e.Shape,"strokeWidth",2),e.Factory.addGetterSetter(e.Shape,"strokeHitEnabled",!0),e.Factory.addGetterSetter(e.Shape,"perfectDrawEnabled",!0),e.Factory.addGetterSetter(e.Shape,"shadowForStrokeEnabled",!0),e.Factory.addGetterSetter(e.Shape,"lineJoin"),e.Factory.addGetterSetter(e.Shape,"lineCap"),e.Factory.addGetterSetter(e.Shape,"sceneFunc"),e.Factory.addGetterSetter(e.Shape,"hitFunc"),e.Factory.addGetterSetter(e.Shape,"dash"),e.Factory.addGetterSetter(e.Shape,"dashOffset",0),e.Factory.addGetterSetter(e.Shape,"shadowColor"),e.Factory.addDeprecatedGetterSetter(e.Shape,"shadowRed",0,e.Validators.RGBComponent),e.Factory.addDeprecatedGetterSetter(e.Shape,"shadowGreen",0,e.Validators.RGBComponent),e.Factory.addDeprecatedGetterSetter(e.Shape,"shadowBlue",0,e.Validators.RGBComponent),e.Factory.addDeprecatedGetterSetter(e.Shape,"shadowAlpha",1,e.Validators.alphaComponent),e.Factory.addGetterSetter(e.Shape,"shadowBlur"),e.Factory.addGetterSetter(e.Shape,"shadowOpacity"),e.Factory.addComponentsGetterSetter(e.Shape,"shadowOffset",["x","y"]),e.Factory.addGetterSetter(e.Shape,"shadowOffsetX",0),e.Factory.addGetterSetter(e.Shape,"shadowOffsetY",0),e.Factory.addGetterSetter(e.Shape,"fillPatternImage"),e.Factory.addGetterSetter(e.Shape,"fill"),e.Factory.addDeprecatedGetterSetter(e.Shape,"fillRed",0,e.Validators.RGBComponent),e.Factory.addDeprecatedGetterSetter(e.Shape,"fillGreen",0,e.Validators.RGBComponent),e.Factory.addDeprecatedGetterSetter(e.Shape,"fillBlue",0,e.Validators.RGBComponent),e.Factory.addDeprecatedGetterSetter(e.Shape,"fillAlpha",1,e.Validators.alphaComponent),e.Factory.addGetterSetter(e.Shape,"fillPatternX",0),e.Factory.addGetterSetter(e.Shape,"fillPatternY",0),e.Factory.addGetterSetter(e.Shape,"fillLinearGradientColorStops"),e.Factory.addGetterSetter(e.Shape,"fillRadialGradientStartRadius",0),e.Factory.addGetterSetter(e.Shape,"fillRadialGradientEndRadius",0),e.Factory.addGetterSetter(e.Shape,"fillRadialGradientColorStops"),e.Factory.addGetterSetter(e.Shape,"fillPatternRepeat","repeat"),e.Factory.addGetterSetter(e.Shape,"fillEnabled",!0),e.Factory.addGetterSetter(e.Shape,"strokeEnabled",!0),e.Factory.addGetterSetter(e.Shape,"shadowEnabled",!0),e.Factory.addGetterSetter(e.Shape,"dashEnabled",!0),e.Factory.addGetterSetter(e.Shape,"strokeScaleEnabled",!0),e.Factory.addGetterSetter(e.Shape,"fillPriority","color"),e.Factory.addComponentsGetterSetter(e.Shape,"fillPatternOffset",["x","y"]),e.Factory.addGetterSetter(e.Shape,"fillPatternOffsetX",0),e.Factory.addGetterSetter(e.Shape,"fillPatternOffsetY",0),e.Factory.addComponentsGetterSetter(e.Shape,"fillPatternScale",["x","y"]),e.Factory.addGetterSetter(e.Shape,"fillPatternScaleX",1),e.Factory.addGetterSetter(e.Shape,"fillPatternScaleY",1),e.Factory.addComponentsGetterSetter(e.Shape,"fillLinearGradientStartPoint",["x","y"]),e.Factory.addGetterSetter(e.Shape,"fillLinearGradientStartPointX",0),e.Factory.addGetterSetter(e.Shape,"fillLinearGradientStartPointY",0),e.Factory.addComponentsGetterSetter(e.Shape,"fillLinearGradientEndPoint",["x","y"]),e.Factory.addGetterSetter(e.Shape,"fillLinearGradientEndPointX",0),e.Factory.addGetterSetter(e.Shape,"fillLinearGradientEndPointY",0),e.Factory.addComponentsGetterSetter(e.Shape,"fillRadialGradientStartPoint",["x","y"]),e.Factory.addGetterSetter(e.Shape,"fillRadialGradientStartPointX",0),e.Factory.addGetterSetter(e.Shape,"fillRadialGradientStartPointY",0),e.Factory.addComponentsGetterSetter(e.Shape,"fillRadialGradientEndPoint",["x","y"]),e.Factory.addGetterSetter(e.Shape,"fillRadialGradientEndPointX",0),e.Factory.addGetterSetter(e.Shape,"fillRadialGradientEndPointY",0),e.Factory.addGetterSetter(e.Shape,"fillPatternRotation",0),e.Factory.backCompat(e.Shape,{dashArray:"dash",getDashArray:"getDash",setDashArray:"getDash",drawFunc:"sceneFunc",getDrawFunc:"getSceneFunc",setDrawFunc:"setSceneFunc",drawHitFunc:"hitFunc",getDrawHitFunc:"getHitFunc",setDrawHitFunc:"setHitFunc"}),e.Collection.mapMethods(e.Shape)}(Konva);