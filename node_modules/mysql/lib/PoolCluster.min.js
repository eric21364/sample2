function PoolCluster(e){EventEmitter.call(this),e=e||{},this._canRetry="undefined"==typeof e.canRetry?!0:e.canRetry,this._defaultSelector=e.defaultSelector||"RR",this._removeNodeErrorCount=e.removeNodeErrorCount||5,this._restoreNodeTimeout=e.restoreNodeTimeout||0,this._closed=!1,this._findCaches=Object.create(null),this._lastId=0,this._namespaces=Object.create(null),this._nodes=Object.create(null)}function getMonotonicMilliseconds(){var e;return"function"==typeof process.hrtime?(e=process.hrtime(),e=1e3*e[0]+1e-6*e[1]):e=1e3*process.uptime(),Math.floor(e)}function isRegExp(e){return"object"==typeof e&&"[object RegExp]"===Object.prototype.toString.call(e)}function patternRegExp(e){if(isRegExp(e))return e;var t=e.replace(/([.+?^=!:${}()|\[\]\/\\])/g,"\\$1").replace(/\*/g,".*");return new RegExp("^"+t+"$")}function _cb(e){if(e)throw e}function _noop(){}var Pool=require("./Pool"),PoolConfig=require("./PoolConfig"),PoolNamespace=require("./PoolNamespace"),PoolSelector=require("./PoolSelector"),Util=require("util"),EventEmitter=require("events").EventEmitter;module.exports=PoolCluster,Util.inherits(PoolCluster,EventEmitter),PoolCluster.prototype.add=function(e,t){if(this._closed)throw new Error("PoolCluster is closed.");var r="object"==typeof e?"CLUSTER::"+ ++this._lastId:String(e);if(void 0!==this._nodes[r])throw new Error('Node ID "'+r+'" is already defined in PoolCluster.');var i=new PoolConfig("object"!=typeof e?t:e);this._nodes[r]={id:r,errorCount:0,pool:new Pool({config:i}),_offlineUntil:0},this._clearFindCaches()},PoolCluster.prototype.end=function(e){function s(e){!r&&(e||--n<=0)&&(r=!0,t(e))}var t=void 0!==e?e:_cb;if("function"!=typeof t)throw TypeError("callback argument must be a function");if(this._closed)return void process.nextTick(t);this._closed=!0;for(var r=!1,i=Object.keys(this._nodes),n=0,a=0;a<i.length;a++){var o=i[a],h=this._nodes[o];n++,h.pool.end(s)}0===n&&process.nextTick(s)},PoolCluster.prototype.of=function(e,t){e=e||"*",t=t||this._defaultSelector,t=t.toUpperCase(),"undefined"==typeof PoolSelector[t]&&(t=this._defaultSelector);var r=e+t;return"undefined"==typeof this._namespaces[r]&&(this._namespaces[r]=new PoolNamespace(this,e,t)),this._namespaces[r]},PoolCluster.prototype.remove=function(e){for(var t=this._findNodeIds(e,!0),r=0;r<t.length;r++){var i=this._getNode(t[r]);i&&this._removeNode(i)}},PoolCluster.prototype.getConnection=function(e,t,r){var i;"function"==typeof e?(r=e,i=this.of()):("function"==typeof t&&(r=t,t=this._defaultSelector),i=this.of(e,t)),i.getConnection(r)},PoolCluster.prototype._clearFindCaches=function(){this._findCaches=Object.create(null)},PoolCluster.prototype._decreaseErrorCount=function(e){var t=e.errorCount;t>this._removeNodeErrorCount&&(t=this._removeNodeErrorCount),1>t&&(t=1),e.errorCount=t-1,e._offlineUntil&&(e._offlineUntil=0,this.emit("online",e.id))},PoolCluster.prototype._findNodeIds=function(e,t){var r=0,i=this._findCaches[e];if(void 0===i){var n=patternRegExp(e),s=Object.keys(this._nodes);i=s.filter(function(e){return e.match(n)}),this._findCaches[e]=i}return t?i:i.filter(function(e){var t=this._getNode(e);return t._offlineUntil?(r||(r=getMonotonicMilliseconds()),t._offlineUntil<=r):!0},this)},PoolCluster.prototype._getNode=function(e){return this._nodes[e]||null},PoolCluster.prototype._increaseErrorCount=function(e){var t=++e.errorCount;if(!(this._removeNodeErrorCount>t)){if(this._restoreNodeTimeout>0)return e._offlineUntil=getMonotonicMilliseconds()+this._restoreNodeTimeout,void this.emit("offline",e.id);this._removeNode(e),this.emit("remove",e.id)}},PoolCluster.prototype._getConnection=function(e,t){var r=this;e.pool.getConnection(function(i,n){return i?(r._increaseErrorCount(e),void t(i)):(r._decreaseErrorCount(e),n._clusterId=e.id,void t(null,n))})},PoolCluster.prototype._removeNode=function(e){delete this._nodes[e.id],this._clearFindCaches(),e.pool.end(_noop)};