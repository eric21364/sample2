function WriteReq(e,t,r){this.chunk=e,this.encoding=t,this.callback=r}function WritableState(e,t){var r=require("./_stream_duplex");e=e||{};var i=e.highWaterMark,n=e.objectMode?16:16384;this.highWaterMark=i||0===i?i:n,this.objectMode=!!e.objectMode,t instanceof r&&(this.objectMode=this.objectMode||!!e.writableObjectMode),this.highWaterMark=~~this.highWaterMark,this.needDrain=!1,this.ending=!1,this.ended=!1,this.finished=!1;var s=e.decodeStrings===!1;this.decodeStrings=!s,this.defaultEncoding=e.defaultEncoding||"utf8",this.length=0,this.writing=!1,this.corked=0,this.sync=!0,this.bufferProcessing=!1,this.onwrite=function(e){onwrite(t,e)},this.writecb=null,this.writelen=0,this.buffer=[],this.pendingcb=0,this.prefinished=!1,this.errorEmitted=!1}function Writable(e){var t=require("./_stream_duplex");return this instanceof Writable||this instanceof t?(this._writableState=new WritableState(e,this),this.writable=!0,void Stream.call(this)):new Writable(e)}function writeAfterEnd(e,t,r){var i=new Error("write after end");e.emit("error",i),process.nextTick(function(){r(i)})}function validChunk(e,t,r,i){var n=!0;if(!(util.isBuffer(r)||util.isString(r)||util.isNullOrUndefined(r)||t.objectMode)){var s=new TypeError("Invalid non-string/buffer chunk");e.emit("error",s),process.nextTick(function(){i(s)}),n=!1}return n}function decodeChunk(e,t,r){return!e.objectMode&&e.decodeStrings!==!1&&util.isString(t)&&(t=new Buffer(t,r)),t}function writeOrBuffer(e,t,r,i,n){r=decodeChunk(t,r,i),util.isBuffer(r)&&(i="buffer");var s=t.objectMode?1:r.length;t.length+=s;var a=t.length<t.highWaterMark;return a||(t.needDrain=!0),t.writing||t.corked?t.buffer.push(new WriteReq(r,i,n)):doWrite(e,t,!1,s,r,i,n),a}function doWrite(e,t,r,i,n,s,a){t.writelen=i,t.writecb=a,t.writing=!0,t.sync=!0,r?e._writev(n,t.onwrite):e._write(n,s,t.onwrite),t.sync=!1}function onwriteError(e,t,r,i,n){r?process.nextTick(function(){t.pendingcb--,n(i)}):(t.pendingcb--,n(i)),e._writableState.errorEmitted=!0,e.emit("error",i)}function onwriteStateUpdate(e){e.writing=!1,e.writecb=null,e.length-=e.writelen,e.writelen=0}function onwrite(e,t){var r=e._writableState,i=r.sync,n=r.writecb;if(onwriteStateUpdate(r),t)onwriteError(e,r,i,t,n);else{var s=needFinish(e,r);s||r.corked||r.bufferProcessing||!r.buffer.length||clearBuffer(e,r),i?process.nextTick(function(){afterWrite(e,r,s,n)}):afterWrite(e,r,s,n)}}function afterWrite(e,t,r,i){r||onwriteDrain(e,t),t.pendingcb--,i(),finishMaybe(e,t)}function onwriteDrain(e,t){0===t.length&&t.needDrain&&(t.needDrain=!1,e.emit("drain"))}function clearBuffer(e,t){if(t.bufferProcessing=!0,e._writev&&t.buffer.length>1){for(var r=[],i=0;i<t.buffer.length;i++)r.push(t.buffer[i].callback);t.pendingcb++,doWrite(e,t,!0,t.length,t.buffer,"",function(e){for(var i=0;i<r.length;i++)t.pendingcb--,r[i](e)}),t.buffer=[]}else{for(var i=0;i<t.buffer.length;i++){var n=t.buffer[i],s=n.chunk,a=n.encoding,o=n.callback,u=t.objectMode?1:s.length;if(doWrite(e,t,!1,u,s,a,o),t.writing){i++;break}}i<t.buffer.length?t.buffer=t.buffer.slice(i):t.buffer.length=0}t.bufferProcessing=!1}function needFinish(e,t){return t.ending&&0===t.length&&!t.finished&&!t.writing}function prefinish(e,t){t.prefinished||(t.prefinished=!0,e.emit("prefinish"))}function finishMaybe(e,t){var r=needFinish(e,t);return r&&(0===t.pendingcb?(prefinish(e,t),t.finished=!0,e.emit("finish")):prefinish(e,t)),r}function endWritable(e,t,r){t.ending=!0,finishMaybe(e,t),r&&(t.finished?process.nextTick(r):e.once("finish",r)),t.ended=!0}module.exports=Writable;var Buffer=require("buffer").Buffer;Writable.WritableState=WritableState;var util=require("core-util-is");util.inherits=require("inherits");var Stream=require("stream");util.inherits(Writable,Stream),Writable.prototype.pipe=function(){this.emit("error",new Error("Cannot pipe. Not readable."))},Writable.prototype.write=function(e,t,r){var i=this._writableState,n=!1;return util.isFunction(t)&&(r=t,t=null),util.isBuffer(e)?t="buffer":t||(t=i.defaultEncoding),util.isFunction(r)||(r=function(){}),i.ended?writeAfterEnd(this,i,r):validChunk(this,i,e,r)&&(i.pendingcb++,n=writeOrBuffer(this,i,e,t,r)),n},Writable.prototype.cork=function(){var e=this._writableState;e.corked++},Writable.prototype.uncork=function(){var e=this._writableState;e.corked&&(e.corked--,e.writing||e.corked||e.finished||e.bufferProcessing||!e.buffer.length||clearBuffer(this,e))},Writable.prototype._write=function(e,t,r){r(new Error("not implemented"))},Writable.prototype._writev=null,Writable.prototype.end=function(e,t,r){var i=this._writableState;util.isFunction(e)?(r=e,e=null,t=null):util.isFunction(t)&&(r=t,t=null),util.isNullOrUndefined(e)||this.write(e,t),i.corked&&(i.corked=1,this.uncork()),i.ending||i.finished||endWritable(this,i,r)};