function encodeBuffer(e,t,r){var i=e.data;if(!t)return exports.encodeBase64Packet(e,r);var n=new Buffer(1);return n[0]=packets[e.type],r(Buffer.concat([n,i]))}function tryDecode(e){try{e=utf8.decode(e)}catch(t){return!1}return e}function map(e,t,r){for(var i=new Array(e.length),n=after(e.length,r),s=function(e,r,n){t(r,function(t,r){i[e]=r,n(t,i)})},a=0;a<e.length;a++)s(a,e[a],n)}function bufferToString(e){for(var t="",r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return t}function stringToBuffer(e){for(var t=new Buffer(e.length),r=0;r<e.length;r++)t.writeUInt8(e.charCodeAt(r),r);return t}function arrayBufferToBuffer(e){for(var t=new Uint8Array(e.buffer||e),r=e.byteLength||e.length,i=e.byteOffset||0,n=new Buffer(r),s=0;r>s;s++)n[s]=t[i+s];return n}var utf8=require("wtf-8"),after=require("after"),keys=require("./keys");exports.protocol=3;var packets=exports.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6},packetslist=keys(packets),err={type:"error",data:"parser error"};exports.encodePacket=function(e,t,r,i){if("function"==typeof t&&(i=t,t=null),"function"==typeof r&&(i=r,r=null),Buffer.isBuffer(e.data))return encodeBuffer(e,t,i);if(e.data&&(e.data.buffer||e.data)instanceof ArrayBuffer)return e.data=arrayBufferToBuffer(e.data),encodeBuffer(e,t,i);var n=packets[e.type];return void 0!==e.data&&(n+=r?utf8.encode(String(e.data)):String(e.data)),i(""+n)},exports.encodeBase64Packet=function(e,t){Buffer.isBuffer(e.data)||(e.data=arrayBufferToBuffer(e.data));var r="b"+packets[e.type];return r+=e.data.toString("base64"),t(r)},exports.decodePacket=function(e,t,r){if(void 0===e)return err;if("string"==typeof e){if("b"==e.charAt(0))return exports.decodeBase64Packet(e.substr(1),t);var i=e.charAt(0);return r&&(e=tryDecode(e),e===!1)?err:Number(i)==i&&packetslist[i]?e.length>1?{type:packetslist[i],data:e.substring(1)}:{type:packetslist[i]}:err}if("arraybuffer"===t){var n=new Uint8Array(e),i=n[0];return{type:packetslist[i],data:n.buffer.slice(1)}}e instanceof ArrayBuffer&&(e=arrayBufferToBuffer(e));var i=e[0];return{type:packetslist[i],data:e.slice(1)}},exports.decodeBase64Packet=function(e,t){var r=packetslist[e.charAt(0)],i=new Buffer(e.substr(1),"base64");if("arraybuffer"===t){for(var n=new Uint8Array(i.length),s=0;s<n.length;s++)n[s]=i[s];i=n.buffer}return{type:r,data:i}},exports.encodePayload=function(e,t,r){function i(e){return e.length+":"+e}function n(e,r){exports.encodePacket(e,t,!0,function(e){r(null,i(e))})}return"function"==typeof t&&(r=t,t=null),t?exports.encodePayloadAsBinary(e,r):e.length?void map(e,n,function(e,t){return r(t.join(""))}):r("0:")},exports.decodePayload=function(e,t,r){if("string"!=typeof e)return exports.decodePayloadAsBinary(e,t,r);"function"==typeof t&&(r=t,t=null);var i;if(""==e)return r(err,0,1);for(var s,a,n="",o=0,h=e.length;h>o;o++){var u=e.charAt(o);if(":"!=u)n+=u;else{if(""==n||n!=(s=Number(n)))return r(err,0,1);if(a=e.substr(o+1,s),n!=a.length)return r(err,0,1);if(a.length){if(i=exports.decodePacket(a,t,!0),err.type==i.type&&err.data==i.data)return r(err,0,1);var c=r(i,o+s,h);if(!1===c)return}o+=s,n=""}}return""!=n?r(err,0,1):void 0},exports.encodePayloadAsBinary=function(e,t){function r(e,t){exports.encodePacket(e,!0,!0,function(e){if("string"==typeof e){var r=""+e.length,i=new Buffer(r.length+2);i[0]=0;for(var n=0;n<r.length;n++)i[n+1]=parseInt(r[n],10);return i[i.length-1]=255,t(null,Buffer.concat([i,stringToBuffer(e)]))}var r=""+e.length,i=new Buffer(r.length+2);i[0]=1;for(var n=0;n<r.length;n++)i[n+1]=parseInt(r[n],10);i[i.length-1]=255,t(null,Buffer.concat([i,e]))})}return e.length?void map(e,r,function(e,r){return t(Buffer.concat(r))}):t(new Buffer(0))},exports.decodePayloadAsBinary=function(e,t,r){"function"==typeof t&&(r=t,t=null);for(var i=e,n=[];i.length>0;){for(var s="",a=0===i[0],o=!1,h=1;255!=i[h];h++){if(s.length>310){o=!0;break}s+=""+i[h]}if(o)return r(err,0,1);i=i.slice(s.length+1);var u=parseInt(s,10),c=i.slice(1,u+1);a&&(c=bufferToString(c)),n.push(c),i=i.slice(u+1)}var l=n.length;n.forEach(function(e,i){r(exports.decodePacket(e,t,!0),i,l)})};