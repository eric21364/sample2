function Server(e,t){return this instanceof Server?("object"!=typeof e||e.listen||(t=e,e=null),t=t||{},this.nsps={},this.path(t.path||"/socket.io"),this.serveClient(!1!==t.serveClient),this.adapter(t.adapter||Adapter),this.origins(t.origins||"*:*"),this.sockets=this.of("/"),void(e&&this.attach(e,t))):new Server(e,t)}var http=require("http"),read=require("fs").readFileSync,engine=require("engine.io"),client=require("socket.io-client"),clientVersion=require("socket.io-client/package").version,Client=require("./client"),Emitter=require("events").EventEmitter,Namespace=require("./namespace"),Adapter=require("socket.io-adapter"),debug=require("debug")("socket.io:server"),url=require("url");module.exports=Server;var clientSource=void 0,clientSourceMap=void 0;Server.prototype.checkRequest=function(e,t){var r=e.headers.origin||e.headers.referer;if(("null"==r||null==r)&&(r="*"),r&&"function"==typeof this._origins)return this._origins(r,t);if(-1!==this._origins.indexOf("*:*"))return t(null,!0);if(r)try{var i=url.parse(r),n="https:"==i.protocol?443:80;i.port=null!=i.port?i.port:n;var s=~this._origins.indexOf(i.hostname+":"+i.port)||~this._origins.indexOf(i.hostname+":*")||~this._origins.indexOf("*:"+i.port);return t(null,!!s)}catch(a){}t(null,!1)},Server.prototype.serveClient=function(e){if(!arguments.length)return this._serveClient;if(this._serveClient=e,e&&!clientSource){clientSource=read(require.resolve("socket.io-client/dist/socket.io.min.js"),"utf-8");try{clientSourceMap=read(require.resolve("socket.io-client/dist/socket.io.js.map"),"utf-8")}catch(t){debug("could not load sourcemap file")}}return this};var oldSettings={transports:"transports","heartbeat timeout":"pingTimeout","heartbeat interval":"pingInterval","destroy buffer size":"maxHttpBufferSize"};Server.prototype.set=function(e,t){return"authorization"==e&&t?this.use(function(e,r){t(e.request,function(e,t){return e?r(new Error(e)):t?void r():r(new Error("Not authorized"))})}):"origins"==e&&t?this.origins(t):"resource"==e?this.path(t):oldSettings[e]&&this.eio[oldSettings[e]]?this.eio[oldSettings[e]]=t:console.error("Option %s is not valid. Please refer to the README.",e),this},Server.prototype.path=function(e){return arguments.length?(this._path=e.replace(/\/$/,""),this):this._path},Server.prototype.adapter=function(e){if(!arguments.length)return this._adapter;this._adapter=e;for(var t in this.nsps)this.nsps.hasOwnProperty(t)&&this.nsps[t].initAdapter();return this},Server.prototype.origins=function(e){return arguments.length?(this._origins=e,this):this._origins},Server.prototype.listen=Server.prototype.attach=function(e,t){if("function"==typeof e){var r="You are trying to attach socket.io to an express request handler function. Please pass a http.Server instance.";throw new Error(r)}if(Number(e)==e&&(e=Number(e)),"number"==typeof e){debug("creating http server and binding to %d",e);var i=e;e=http.Server(function(e,t){t.writeHead(404),t.end()}),e.listen(i)}return t=t||{},t.path=t.path||this.path(),t.allowRequest=t.allowRequest||this.checkRequest.bind(this),debug("creating engine.io instance with opts %j",t),this.eio=engine.attach(e,t),this._serveClient&&this.attachServe(e),this.httpServer=e,this.bind(this.eio),this},Server.prototype.attachServe=function(e){debug("attaching client serving req handler");var t=this._path+"/socket.io.js",r=this._path+"/socket.io.js.map",i=e.listeners("request").slice(0),n=this;e.removeAllListeners("request"),e.on("request",function(s,a){if(0===s.url.indexOf(r))n.serveMap(s,a);else if(0===s.url.indexOf(t))n.serve(s,a);else for(var o=0;o<i.length;o++)i[o].call(e,s,a)})},Server.prototype.serve=function(e,t){var r='"'+clientVersion+'"',i=e.headers["if-none-match"];return i&&r==i?(debug("serve client 304"),t.writeHead(304),void t.end()):(debug("serve client source"),t.setHeader("Content-Type","application/javascript"),t.setHeader("ETag",r),t.setHeader("X-SourceMap","socket.io.js.map"),t.writeHead(200),void t.end(clientSource))},Server.prototype.serveMap=function(e,t){var r='"'+clientVersion+'"',i=e.headers["if-none-match"];return i&&r==i?(debug("serve client 304"),t.writeHead(304),void t.end()):(debug("serve client sourcemap"),t.setHeader("Content-Type","application/json"),t.setHeader("ETag",r),t.writeHead(200),void t.end(clientSourceMap))},Server.prototype.bind=function(e){return this.engine=e,this.engine.on("connection",this.onconnection.bind(this)),this},Server.prototype.onconnection=function(e){debug("incoming connection with id %s",e.id);var t=new Client(this,e);return t.connect("/"),this},Server.prototype.of=function(e,t){"/"!==String(e)[0]&&(e="/"+e);var r=this.nsps[e];return r||(debug("initializing namespace %s",e),r=new Namespace(this,e),this.nsps[e]=r),t&&r.on("connect",t),r},Server.prototype.close=function(e){for(var t in this.nsps["/"].sockets)this.nsps["/"].sockets.hasOwnProperty(t)&&this.nsps["/"].sockets[t].onclose();this.engine.close(),this.httpServer?this.httpServer.close(e):e&&e()};var emitterMethods=Object.keys(Emitter.prototype).filter(function(e){return"function"==typeof Emitter.prototype[e]});emitterMethods.concat(["to","in","use","send","write","clients","compress"]).forEach(function(e){Server.prototype[e]=function(){return this.sockets[e].apply(this.sockets,arguments)}}),Namespace.flags.forEach(function(e){Object.defineProperty(Server.prototype,e,{get:function(){return this.sockets.flags=this.sockets.flags||{},this.sockets.flags[e]=!0,this}})}),Server.listen=Server;