"use strict";var Lexer=require("./lexer"),nodes=require("./nodes"),utils=require("./utils"),filters=require("./filters"),path=require("path"),constantinople=require("constantinople"),parseJSExpression=require("character-parser").parseMax,extname=path.extname,Parser=exports=module.exports=function(e,t,r){this.input=e.replace(/^\uFEFF/,""),this.lexer=new Lexer(this.input,t),this.filename=t,this.blocks={},this.mixins={},this.options=r,this.contexts=[this],this.inMixin=0,this.dependencies=[],this.inBlock=0};Parser.prototype={constructor:Parser,context:function(e){return e?void this.contexts.push(e):this.contexts.pop()},advance:function(){return this.lexer.advance()},peek:function(){return this.lookahead(1)},line:function(){return this.lexer.lineno},lookahead:function(e){return this.lexer.lookahead(e)},parse:function(){var t,e=new nodes.Block;for(e.line=0,e.filename=this.filename;"eos"!=this.peek().type;)if("newline"==this.peek().type)this.advance();else{var r=this.peek(),i=this.parseExpr();i.filename=i.filename||this.filename,i.line=r.line,e.push(i)}if(t=this.extending){this.context(t);var n=t.parse();this.context();for(var s in this.mixins)n.unshift(this.mixins[s]);return n}if(!this.extending&&!this.included&&Object.keys(this.blocks).length){var a=[];utils.walkAST(e,function(e){"Block"===e.type&&e.name&&a.push(e.name)}),Object.keys(this.blocks).forEach(function(e){-1!==a.indexOf(e)||this.blocks[e].isSubBlock||console.warn('Warning: Unexpected block "'+e+'"  on line '+this.blocks[e].line+" of "+this.blocks[e].filename+". This block is never used. This warning will be an error in v2.0.0")}.bind(this))}return e},expect:function(e){if(this.peek().type===e)return this.advance();throw new Error('expected "'+e+'", but got "'+this.peek().type+'"')},accept:function(e){return this.peek().type===e?this.advance():void 0},parseExpr:function(){switch(this.peek().type){case"tag":return this.parseTag();case"mixin":return this.parseMixin();case"block":return this.parseBlock();case"mixin-block":return this.parseMixinBlock();case"case":return this.parseCase();case"extends":return this.parseExtends();case"include":return this.parseInclude();case"doctype":return this.parseDoctype();case"filter":return this.parseFilter();case"comment":return this.parseComment();case"text":return this.parseText();case"each":return this.parseEach();case"code":return this.parseCode();case"blockCode":return this.parseBlockCode();case"call":return this.parseCall();case"interpolation":return this.parseInterpolation();case"yield":this.advance();var e=new nodes.Block;return e["yield"]=!0,e;case"id":case"class":var t=this.advance();return this.lexer.defer(this.lexer.tok("tag","div")),this.lexer.defer(t),this.parseExpr();default:throw new Error('unexpected token "'+this.peek().type+'"')}},parseText:function(){var e=this.expect("text"),t=this.parseInlineTagsInText(e.val);if(1===t.length)return t[0];for(var r=new nodes.Block,i=0;i<t.length;i++)r.push(t[i]);return r},parseBlockExpansion:function(){return":"==this.peek().type?(this.advance(),new nodes.Block(this.parseExpr())):this.block()},parseCase:function(){var e=this.expect("case").val,t=new nodes.Case(e);t.line=this.line();var r=new nodes.Block;for(r.line=this.line(),r.filename=this.filename,this.expect("indent");"outdent"!=this.peek().type;)switch(this.peek().type){case"comment":case"newline":this.advance();break;case"when":r.push(this.parseWhen());break;case"default":r.push(this.parseDefault());break;default:throw new Error('Unexpected token "'+this.peek().type+'", expected "when", "default" or "newline"')}return this.expect("outdent"),t.block=r,t},parseWhen:function(){var e=this.expect("when").val;return"newline"!==this.peek().type?new nodes.Case.When(e,this.parseBlockExpansion()):new nodes.Case.When(e)},parseDefault:function(){return this.expect("default"),new nodes.Case.When("default",this.parseBlockExpansion())},parseCode:function(e){var i,t=this.expect("code"),r=new nodes.Code(t.val,t.buffer,t.escape);if(r.line=this.line(),t.isElse&&!t.hasIf)throw new Error("Unexpected else without if");return i="indent"==this.peek().type,i&&(r.block=this.block()),t.requiresBlock&&!i&&(r.block=new nodes.Block),t.isIf&&this.peek().isElse?this.peek().hasIf=!0:t.isIf&&"newline"===this.peek().type&&this.lookahead(2).isElse&&(this.lookahead(2).hasIf=!0),r},parseBlockCode:function(){var t,i,r=(this.expect("blockCode"),this.peek());return"pipeless-text"===r.type?(this.advance(),i=r.val.join("\n")):i="",t=new nodes.Code(i,!1,!1)},parseComment:function(){var t,r,e=this.expect("comment");return t=(r=this.parseTextBlock())?new nodes.BlockComment(e.val,r,e.buffer):new nodes.Comment(e.val,e.buffer),t.line=this.line(),t},parseDoctype:function(){var e=this.expect("doctype"),t=new nodes.Doctype(e.val);return t.line=this.line(),t},parseFilter:function(){var r,e=this.expect("filter"),t=this.accept("attrs");r=this.parseTextBlock()||new nodes.Block;var i={};t&&t.attrs.forEach(function(e){i[e.name]=constantinople.toConstant(e.val)});var n=new nodes.Filter(e.val,r,i);return n.line=this.line(),n},parseEach:function(){var e=this.expect("each"),t=new nodes.Each(e.code,e.val,e.key);return t.line=this.line(),t.block=this.block(),"code"==this.peek().type&&"else"==this.peek().val&&(this.advance(),t.alternative=this.block()),t},resolvePath:function(e,t){var r=require("path"),i=r.dirname,n=r.basename,s=r.join;if("/"!==e[0]&&!this.filename)throw new Error('the "filename" option is required to use "'+t+'" with "relative" paths');if("/"===e[0]&&!this.options.basedir)throw new Error('the "basedir" option is required to use "'+t+'" with "absolute" paths');return e=s("/"===e[0]?this.options.basedir:i(this.filename),e),-1===n(e).indexOf(".")&&(e+=".jade"),e},parseExtends:function(){var e=require("fs"),t=this.resolvePath(this.expect("extends").val.trim(),"extends");".jade"!=t.substr(-5)&&(t+=".jade"),this.dependencies.push(t);var r=e.readFileSync(t,"utf8"),i=new this.constructor(r,t,this.options);return i.dependencies=this.dependencies,i.blocks=this.blocks,i.included=this.included,i.contexts=this.contexts,this.extending=i,new nodes.Literal("")},parseBlock:function(){var e=this.expect("block"),t=e.mode,r=e.val.trim(),i=e.line;this.inBlock++,e="indent"==this.peek().type?this.block():new nodes.Block(new nodes.Literal("")),this.inBlock--,e.name=r,e.line=i;var n=this.blocks[r]||{prepended:[],appended:[]};if("replace"===n.mode)return this.blocks[r]=n;var s=n.prepended.concat(e.nodes).concat(n.appended);switch(t){case"append":n.appended=n.parser===this?n.appended.concat(e.nodes):e.nodes.concat(n.appended);break;case"prepend":n.prepended=n.parser===this?e.nodes.concat(n.prepended):n.prepended.concat(e.nodes)}return e.nodes=s,e.appended=n.appended,e.prepended=n.prepended,e.mode=t,e.parser=this,e.isSubBlock=this.inBlock>0,this.blocks[r]=e},parseMixinBlock:function(){this.expect("mixin-block");if(!this.inMixin)throw new Error("Anonymous blocks are not allowed unless they are part of a mixin.");return new nodes.MixinBlock},parseInclude:function(){var e=require("fs"),t=this.expect("include"),r=this.resolvePath(t.val.trim(),"include");if(this.dependencies.push(r),t.filter){var i=e.readFileSync(r,"utf8").replace(/\r/g,""),n={filename:r};return t.attrs&&t.attrs.attrs.forEach(function(e){n[e.name]=constantinople.toConstant(e.val)}),i=filters(t.filter,i,n),new nodes.Literal(i)}if(".jade"!=r.substr(-5)){var i=e.readFileSync(r,"utf8").replace(/\r/g,"");return new nodes.Literal(i)}var i=e.readFileSync(r,"utf8"),s=new this.constructor(i,r,this.options);s.dependencies=this.dependencies,s.blocks=utils.merge({},this.blocks),s.included=!0,s.mixins=this.mixins,this.context(s);var a=s.parse();return this.context(),a.filename=r,"indent"==this.peek().type&&a.includeBlock().push(this.block()),a},parseCall:function(){var e=this.expect("call"),t=e.val,r=e.args,i=new nodes.Mixin(t,r,new nodes.Block,!0);return this.tag(i),i.code&&(i.block.push(i.code),i.code=null),i.block.isEmpty()&&(i.block=null),i},parseMixin:function(){var i,e=this.expect("mixin"),t=e.val,r=e.args;return"indent"==this.peek().type?(this.inMixin++,i=new nodes.Mixin(t,r,this.block(),!1),this.mixins[t]=i,this.inMixin--,i):new nodes.Mixin(t,r,null,!0)},parseInlineTagsInText:function(e){var t=this.line(),r=/(\\)?#\[((?:.|\n)*)$/.exec(e);if(r){if(r[1]){var i=new nodes.Text(e.substr(0,r.index)+"#[");i.line=t;var n=this.parseInlineTagsInText(r[2]);return"Text"===n[0].type&&(i.val+=n[0].val,n.shift()),[i].concat(n)}var i=new nodes.Text(e.substr(0,r.index));i.line=t;var s=[i],n=r[2],a=parseJSExpression(n),o=new Parser(a.src,this.filename,this.options);return s.push(o.parse()),s.concat(this.parseInlineTagsInText(n.substr(a.end+1)))}var i=new nodes.Text(e);return i.line=t,[i]},parseTextBlock:function(){var e=new nodes.Block;e.line=this.line();var t=this.peek();if("pipeless-text"===t.type)return this.advance(),e.nodes=t.val.reduce(function(e,t){return e.concat(this.parseInlineTagsInText(t))}.bind(this),[]),e},block:function(){var e=new nodes.Block;for(e.line=this.line(),e.filename=this.filename,this.expect("indent");"outdent"!=this.peek().type;)if("newline"==this.peek().type)this.advance();else{var t=this.parseExpr();t.filename=this.filename,e.push(t)}return this.expect("outdent"),e},parseInterpolation:function(){var e=this.advance(),t=new nodes.Tag(e.val);return t.buffer=!0,this.tag(t)},parseTag:function(){var e=this.advance(),t=new nodes.Tag(e.val);return t.selfClosing=e.selfClosing,this.tag(t)},tag:function(e){e.line=this.line();var t=!1;e:for(;;)switch(this.peek().type){case"id":case"class":var r=this.advance();e.setAttribute(r.type,"'"+r.val+"'");continue;case"attrs":t&&console.warn(this.filename+", line "+this.peek().line+":\nYou should not have jade tags with multiple attributes."),t=!0;var r=this.advance(),i=r.attrs;r.selfClosing&&(e.selfClosing=!0);for(var n=0;n<i.length;n++)e.setAttribute(i[n].name,i[n].val,i[n].escaped);continue;case"&attributes":var r=this.advance();e.addAttributes(r.val);break;default:break e}switch("dot"==this.peek().type&&(e.textOnly=!0,this.advance()),this.peek().type){case"text":e.block.push(this.parseText());break;case"code":e.code=this.parseCode();break;case":":this.advance(),e.block=new nodes.Block,e.block.push(this.parseExpr());break;case"newline":case"indent":case"outdent":case"eos":case"pipeless-text":break;default:throw new Error("Unexpected token `"+this.peek().type+"` expected `text`, `code`, `:`, `newline` or `eos`")}for(;"newline"==this.peek().type;)this.advance();if(e.textOnly)e.block=this.parseTextBlock()||new nodes.Block;else if("indent"==this.peek().type)for(var s=this.block(),n=0,a=s.nodes.length;a>n;++n)e.block.push(s.nodes[n]);return e}};